<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTCfi Pulse Alpha</title>
  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAABAGlDQ1BpY2MAABiVY2BgPMEABCwGDAy5eSVFQe5OChGRUQrsDxgYgRAMEpOLCxhwA6Cqb9cgai/r4lGHC3CmpBYnA+kPQKxSBLQcaKQIkC2SDmFrgNhJELYNiF1eUlACZAeA2EUhQc5AdgqQrZGOxE5CYicXFIHU9wDZNrk5pckIdzPwpOaFBgNpDiCWYShmCGJwZ3AC+R+iJH8RA4PFVwYG5gkIsaSZDAzbWxkYJG4hxFQWMDDwtzAwbDuPEEOESUFiUSJYiAWImdLSGBg+LWdg4I1kYBC+wMDAFQ0LCBxuUwC7zZ0hHwjTGXIYUoEingx5DMkMekCWEYMBgyGDGQCm1j8/yRb+6wAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAA9lBMVEUFARgGAhkGARkJARkJAhkJAhoIARkHARkEARcAABMAABIBABYCARcUAx1fCDZeCDZkCDhhCDdVCDMfAyAAABQIAhkAARUwBSf9FGz+E2zcEWHuEmf8E2vpEmUEARgvBSbzE2j/FHBcCDOuDlD/FG/9E2zgEmIRAhwGARgAARYnBCPAD1erDlBgCTViCjaGC0PLD1osBSYAABUHAhkcAyCXDUpTCDJxCztoCjp5Cj+fDUzfEmIwBSb/FW7sEmb8FG79FXJlCTctBSXvE2eKDEV3Cj8xBScHARgrBCX1FGnGEFkuBCb/FW/VEV4QAhxQBzFCBiwFARcJm6iHAAAAB3RJTUUH6gEbEhoYfZB++QAAAL5JREFUGNNdj+cOwjAMhE0LTRvKDhvC3jvsvSkb8v4vQyhUSPiHZX+S784AomzwV5Jslx0K+gFV0zDWnBaRdJfb4/X5A0T6gGAoHInG4omknyD6BiiUSmeyuXyhWNLLJqhUa/VGs9VOdpgp0630+oPhaDyZupymCiKz+aK4XOXX5OPTZZvtdNfaH4SLEKVgsOPpjDFmVg7ELtebrMjfnUJZvz+eVmj6vgKqkd8fZjbFAODAuSq6mFTxHheTABxe7WcUi0xy1NoAAAAedEVYdGljYzpjb3B5cmlnaHQAR29vZ2xlIEluYy4gMjAxNqwLMzgAAAAUdEVYdGljYzpkZXNjcmlwdGlvbgBzUkdCupBzBwAAAABJRU5ErkJggg==">
  <link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAABAGlDQ1BpY2MAABiVY2BgPMEABCwGDAy5eSVFQe5OChGRUQrsDxgYgRAMEpOLCxhwA6Cqb9cgai/r4lGHC3CmpBYnA+kPQKxSBLQcaKQIkC2SDmFrgNhJELYNiF1eUlACZAeA2EUhQc5AdgqQrZGOxE5CYicXFIHU9wDZNrk5pckIdzPwpOaFBgNpDiCWYShmCGJwZ3AC+R+iJH8RA4PFVwYG5gkIsaSZDAzbWxkYJG4hxFQWMDDwtzAwbDuPEEOESUFiUSJYiAWImdLSGBg+LWdg4I1kYBC+wMDAFQ0LCBxuUwC7zZ0hHwjTGXIYUoEingx5DMkMekCWEYMBgyGDGQCm1j8/yRb+6wAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAA9lBMVEUFARgGAhkGARkJARkJAhkJAhoIARkHARkEARcAABMAABIBABYCARcUAx1fCDZeCDZkCDhhCDdVCDMfAyAAABQIAhkAARUwBSf9FGz+E2zcEWHuEmf8E2vpEmUEARgvBSbzE2j/FHBcCDOuDlD/FG/9E2zgEmIRAhwGARgAARYnBCPAD1erDlBgCTViCjaGC0PLD1osBSYAABUHAhkcAyCXDUpTCDJxCztoCjp5Cj+fDUzfEmIwBSb/FW7sEmb8FG79FXJlCTctBSXvE2eKDEV3Cj8xBScHARgrBCX1FGnGEFkuBCb/FW/VEV4QAhxQBzFCBiwFARcJm6iHAAAAB3RJTUUH6gEbEhoYfZB++QAAAL5JREFUGNNdj+cOwjAMhE0LTRvKDhvC3jvsvSkb8v4vQyhUSPiHZX+S784AomzwV5Jslx0K+gFV0zDWnBaRdJfb4/X5A0T6gGAoHInG4omknyD6BiiUSmeyuXyhWNLLJqhUa/VGs9VOdpgp0630+oPhaDyZupymCiKz+aK4XOXX5OPTZZvtdNfaH4SLEKVgsOPpjDFmVg7ELtebrMjfnUJZvz+eVmj6vgKqkd8fZjbFAODAuSq6mFTxHheTABxe7WcUi0xy1NoAAAAedEVYdGljYzpjb3B5cmlnaHQAR29vZ2xlIEluYy4gMjAxNqwLMzgAAAAUdEVYdGljYzpkZXNjcmlwdGlvbgBzUkdCupBzBwAAAABJRU5ErkJggg==">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg-primary: #0a0a12;
      --bg-secondary: #0f0f1a;
      --bg-card: #151520;
      --bg-card-hover: #1a1a28;
      --bg-input: #1a1a28;
      --accent-purple: #a855f7;
      --accent-purple-dim: #7c3aed;
      --accent-magenta: #c026d3;
      --accent-cyan: #16d9f1;
      --accent-green: #22c55e;
      --accent-red: #ef4444;
      --accent-discord: #5865F2;
      --text-primary: #ffffff;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --border-color: #252532;
      --border-light: #2a2a3a;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-primary);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo { display: flex; align-items: baseline; font-size: 1.5rem; font-weight: 700; }
    .logo-otc { color: var(--text-primary); }
    .logo-fi { color: var(--accent-cyan); }
    .logo-pulse { font-size: 0.7rem; color: #fb3393; margin-left: 2px; font-weight: 600; }
    .nav { display: flex; gap: 2rem; }
    .nav-link {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.2s;
      background: none;
      border: none;
      font-family: inherit;
    }
    .nav-link:hover, .nav-link.active { color: var(--text-primary); }
    .header-right { display: flex; align-items: center; gap: 1rem; }
    .balance-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.6rem 1rem;
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.9rem;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .user-btn {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
    }
    .user-btn:hover { border-color: var(--accent-purple); color: var(--text-primary); }
    .main { max-width: 1300px; margin: 0 auto; padding: 2rem; }
    .page-title { font-size: 2rem; font-weight: 600; margin-bottom: 0.5rem; }
    .page-subtitle { color: var(--text-secondary); font-size: 1rem; margin-bottom: 2rem; }
    .stats-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; gap: 2rem; }
    .stat-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .stat-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 1.75rem; font-weight: 600; }
    .category-filters { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .category-pill {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-secondary);
      font-family: inherit;
      transition: all 0.2s;
    }
    .category-pill:hover { border-color: var(--text-muted); color: var(--text-primary); }
    .category-pill.active { background: var(--accent-purple); border-color: var(--accent-purple); color: white; }
    .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 1rem; }
    .market-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .market-card:hover { border-color: var(--border-light); background: var(--bg-card-hover); }
    .market-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
    .market-ticker-row { display: flex; align-items: center; gap: 0.75rem; }
    .ticker-badge {
      background: var(--bg-input);
      border: 1px solid var(--border-light);
      border-radius: 6px;
      padding: 0.3rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .category-badge {
      background: rgba(168, 85, 247, 0.15);
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-radius: 6px;
      padding: 0.3rem 0.5rem;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--accent-purple);
      text-transform: uppercase;
    }
    .market-company { font-size: 0.85rem; color: var(--text-secondary); }
    .market-date { font-size: 0.8rem; color: var(--text-muted); }
    .countdown-badge { 
      font-size: 0.75rem; 
      color: var(--text-secondary); 
      background: var(--bg-secondary); 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px;
      font-weight: 500;
    }
    .countdown-badge.urgent { 
      background: rgba(251, 51, 147, 0.15); 
      color: #fb3393; 
      animation: pulse-urgent 2s infinite;
    }
    @keyframes pulse-urgent { 
      0%, 100% { opacity: 1; } 
      50% { opacity: 0.7; } 
    }
    .countdown-text-urgent { color: #fb3393; }
    .market-title { font-size: 1rem; font-weight: 500; margin-bottom: 0.75rem; line-height: 1.4; }
    .market-footer { display: flex; justify-content: space-between; align-items: center; }
    .market-meta { display: flex; gap: 1rem; font-size: 0.8rem; color: var(--text-muted); }
    .market-odds { display: flex; gap: 0.5rem; }
    .odds-pill { padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
    .odds-yes { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); border: 1px solid rgba(34, 197, 94, 0.3); }
    .odds-no { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); border: 1px solid rgba(239, 68, 68, 0.3); }
    .bet-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.75rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .bet-available { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); border: 1px solid rgba(34, 197, 94, 0.3); }
    .bet-used { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); border: 1px solid rgba(239, 68, 68, 0.3); }
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 2rem;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content {
      background: var(--bg-primary);
      border-radius: 16px;
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 1rem;
      cursor: pointer;
      background: none;
      border: none;
      font-family: inherit;
    }
    .back-link:hover { color: var(--text-primary); }
    .detail-header { display: flex; align-items: flex-start; gap: 1rem; }
    .detail-ticker {
      width: 50px;
      height: 50px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      color: var(--accent-purple);
    }
    .detail-info h2 { font-size: 0.9rem; color: var(--text-muted); font-weight: 400; margin-bottom: 0.25rem; }
    .detail-info h1 { font-size: 1.25rem; font-weight: 600; }
    .detail-tags { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
    .detail-tag {
      padding: 0.4rem 0.75rem;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    .detail-tag.tag-urgent {
      background: rgba(251, 51, 147, 0.15);
      border-color: rgba(251, 51, 147, 0.3);
      color: #fb3393;
      animation: pulse-urgent 2s infinite;
    }
    .detail-body { padding: 1.5rem; }
    .resolution-text { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1.5rem; }
    .market-odds-section {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .market-odds-title { font-weight: 600; margin-bottom: 1rem; }
    .odds-display { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .odds-box { background: var(--bg-input); border-radius: 8px; padding: 1rem; }
    .odds-box-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; }
    .odds-box-value { font-size: 1.5rem; font-weight: 600; }
    .odds-box-value.yes { color: var(--accent-green); }
    .odds-box-value.no { color: var(--accent-red); }
    .wager-section {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(192, 38, 211, 0.1));
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-radius: 12px;
      padding: 1.5rem;
    }
    .wager-title { font-weight: 600; margin-bottom: 0.5rem; }
    .wager-balance { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem; }
    .bet-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem; }
    .bet-btn {
      padding: 0.9rem;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .bet-btn-yes { background: var(--accent-purple); border: none; color: white; }
    .bet-btn-yes:hover:not(:disabled) { background: var(--accent-purple-dim); }
    .bet-btn-no { background: transparent; border: 1px solid var(--border-light); color: var(--text-primary); }
    .bet-btn-no:hover:not(:disabled) { background: var(--bg-card); }
    .bet-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .bet-btn.selected { box-shadow: 0 0 0 2px var(--accent-purple); }
    .wager-info { background: var(--bg-input); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .wager-info-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 0.5rem; }
    .wager-info-row:last-child { margin-bottom: 0; }
    .wager-info-label { color: var(--text-muted); }
    .wager-info-value { font-weight: 500; }
    .wager-info-value.yes { color: var(--accent-green); }
    .wager-info-value.no { color: var(--accent-red); }
    .place-wager-btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-magenta));
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .place-wager-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4); }
    .place-wager-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .demo-notice { text-align: center; font-size: 0.8rem; color: var(--text-muted); margin-top: 1rem; }
    .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; }
    .login-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 2.5rem;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .login-subtitle { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 2rem; }
    .discord-btn {
      width: 100%;
      padding: 1rem;
      background: var(--accent-discord);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }
    .discord-btn:hover { background: #4752c4; transform: translateY(-1px); box-shadow: 0 4px 20px rgba(88, 101, 242, 0.4); }
    .discord-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .discord-btn svg { width: 24px; height: 24px; }
    .login-btn, .btn-primary {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-magenta));
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .login-btn:hover, .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4); }
    .login-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .form-group { margin-bottom: 1.25rem; text-align: left; }
    .form-label { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.85rem 1rem;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-purple); }
    .form-input::placeholder { color: var(--text-muted); }
    .form-textarea { min-height: 100px; resize: vertical; }
    .leaderboard {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
    }
    .leaderboard-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .leaderboard-row {
      display: flex;
      align-items: center;
      padding: 0.9rem 1.25rem;
      border-bottom: 1px solid var(--border-color);
      transition: background 0.2s;
    }
    .leaderboard-row:last-child { border-bottom: none; }
    .leaderboard-row:hover { background: var(--bg-card-hover); }
    .leaderboard-rank { width: 32px; font-weight: 700; color: var(--text-muted); }
    .leaderboard-rank.gold { color: #fbbf24; }
    .leaderboard-rank.silver { color: #9ca3af; }
    .leaderboard-rank.bronze { color: #d97706; }
    .leaderboard-user { flex: 1; display: flex; align-items: center; gap: 0.75rem; }
    .leaderboard-avatar {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.75rem;
      color: white;
      overflow: hidden;
    }
    .leaderboard-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .leaderboard-name { font-weight: 500; }
    .leaderboard-stats { display: flex; gap: 2rem; font-size: 0.9rem; }
    .leaderboard-wins { color: var(--accent-green); }
    .leaderboard-earnings { color: var(--accent-purple); }
    .admin-section {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .admin-section-title { font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .pending-item {
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }
    .pending-item:last-child { margin-bottom: 0; }
    .pending-info { flex: 1; }
    .pending-title { font-weight: 500; margin-bottom: 0.25rem; }
    .pending-meta { font-size: 0.8rem; color: var(--text-muted); }
    .pending-actions { display: flex; gap: 0.5rem; }
    .btn-sm {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .btn-approve { background: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.3); color: var(--accent-green); }
    .btn-approve:hover { background: var(--accent-green); color: white; }
    .btn-reject { background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); color: var(--accent-red); }
    .btn-reject:hover { background: var(--accent-red); color: white; }
    .create-modal {
      background: var(--bg-card);
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .create-modal-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .create-modal-title { font-size: 1.1rem; font-weight: 600; }
    .close-btn { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; line-height: 1; }
    .close-btn:hover { color: var(--text-primary); }
    .create-modal-body { padding: 1.5rem; }
    .create-modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }
    .btn {
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .btn-secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
    .btn-secondary:hover { background: var(--bg-card-hover); border-color: var(--text-muted); }
    .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.5rem; }
    .toast {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .toast-success { border-color: var(--accent-green); }
    .toast-error { border-color: var(--accent-red); }
    .toast-icon { font-size: 1.1rem; }
    .toast-success .toast-icon { color: var(--accent-green); }
    .toast-error .toast-icon { color: var(--accent-red); }
    .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-muted); }
    .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    .empty-state-title { font-size: 1.1rem; font-weight: 500; color: var(--text-primary); margin-bottom: 0.5rem; }
    
    /* History Page */
    .history-list { display: flex; flex-direction: column; gap: 1rem; }
    .history-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      transition: all 0.2s;
    }
    .history-card:hover { border-color: var(--border-light); }
    .history-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.5rem; }
    .history-ticker-row { display: flex; align-items: center; gap: 0.75rem; }
    .history-ticker { font-weight: 600; color: var(--accent-cyan); font-size: 1rem; }
    .history-result { font-size: 0.8rem; font-weight: 600; padding: 0.25rem 0.6rem; border-radius: 6px; }
    .result-yes { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
    .result-no { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
    .history-date { font-size: 0.8rem; color: var(--text-muted); }
    .history-title { font-size: 0.95rem; color: var(--text-primary); margin-bottom: 0.75rem; line-height: 1.4; }
    .history-meta { display: flex; gap: 1rem; font-size: 0.8rem; color: var(--text-muted); }
    .history-category { background: var(--bg-secondary); padding: 0.2rem 0.5rem; border-radius: 4px; }
    
    .suggest-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1rem;
      background: var(--accent-purple);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .suggest-btn:hover { background: var(--accent-purple-dim); }
    .already-bet-notice {
      text-align: center;
      padding: 1rem;
      background: var(--bg-input);
      border-radius: 8px;
      color: var(--text-secondary);
    }
    .already-bet-notice strong { color: var(--accent-green); }
    .category-select-group { display: flex; gap: 0.5rem; margin-bottom: 1.25rem; }
    .category-select-btn {
      flex: 1;
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }
    .category-select-btn:hover { border-color: var(--text-muted); color: var(--text-primary); }
    .category-select-btn.active { background: var(--accent-purple); border-color: var(--accent-purple); color: white; }
    .confirm-modal {
      background: var(--bg-card);
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      padding: 2rem;
      text-align: center;
    }
    .confirm-icon { font-size: 3rem; margin-bottom: 1rem; }
    .confirm-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
    .confirm-message { color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem; }
    .confirm-details { background: var(--bg-input); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; text-align: left; }
    .confirm-detail-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .confirm-detail-row:last-child { margin-bottom: 0; }
    .confirm-detail-label { color: var(--text-muted); }
    .confirm-detail-value { font-weight: 500; }
    .confirm-detail-value.yes { color: var(--accent-green); }
    .confirm-detail-value.no { color: var(--accent-red); }
    .confirm-buttons { display: flex; gap: 0.75rem; }
    .confirm-buttons .btn { flex: 1; }
    .confirm-warning { color: var(--accent-red); font-size: 0.85rem; margin-top: 1rem; }
    .loading { text-align: center; padding: 4rem; color: var(--text-muted); }
    .loading-spinner { font-size: 2rem; animation: spin 1s linear infinite; display: inline-block; margin-bottom: 1rem; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    /* Profile Page Styles */
    .profile-header { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem; }
    .profile-avatar-large {
      width: 100px;
      height: 100px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 2rem;
      color: white;
      overflow: hidden;
      flex-shrink: 0;
    }
    .profile-avatar-large img { width: 100%; height: 100%; object-fit: cover; }
    .profile-info { flex: 1; }
    .profile-username { font-size: 1.75rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.25rem; }
    .admin-badge { background: var(--accent-purple); color: white; font-size: 0.7rem; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; }
    .profile-joined { color: var(--text-muted); font-size: 0.9rem; }
    .profile-private-notice { color: var(--text-muted); font-size: 0.95rem; margin-top: 0.5rem; }
    .profile-section { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .profile-section-title { font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
    .stat-card { background: var(--bg-input); border-radius: 8px; padding: 1rem; text-align: center; }
    .stat-card-value { font-size: 1.5rem; font-weight: 700; color: var(--accent-purple); margin-bottom: 0.25rem; }
    .stat-card-label { font-size: 0.8rem; color: var(--text-muted); }
    .privacy-toggle { margin-bottom: 1rem; }
    .toggle-label { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
    .toggle-label input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent-purple); cursor: pointer; }
    .toggle-text { font-weight: 500; }
    .toggle-description { color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem; margin-left: 1.75rem; }
    .history-filters { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .history-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .history-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-input); border-radius: 8px; padding: 1rem; }
    .history-info { flex: 1; }
    .history-market { font-weight: 500; margin-bottom: 0.25rem; }
    .history-meta { font-size: 0.85rem; color: var(--text-muted); }
    .text-green { color: var(--accent-green); }
    .text-red { color: var(--accent-red); }
    .history-result { font-weight: 600; font-size: 0.85rem; padding: 0.4rem 0.75rem; border-radius: 6px; }
    .history-result.won { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
    .history-result.lost { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
    .history-result.pending { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }
    .profile-link:hover { border-color: var(--accent-purple); }
    
    /* Alpha Badge */
    .alpha-badge { background: linear-gradient(135deg, #fb3393, #16d9f1); color: white; font-size: 0.8rem; font-weight: 600; padding: 0.4rem 0.75rem; border-radius: 20px; }
    
    /* Activity Sidebar */
    .markets-layout { display: flex; gap: 1.5rem; }
    .markets-content { flex: 1; min-width: 0; }
    .activity-toggle-btn { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); padding: 0.6rem 0.9rem; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: all 0.2s; }
    .activity-toggle-btn:hover { border-color: var(--accent-purple); background: var(--bg-secondary); }
    .activity-sidebar { width: 300px; flex-shrink: 0; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; height: fit-content; max-height: calc(100vh - 150px); display: flex; flex-direction: column; position: sticky; top: 100px; }
    .activity-header { padding: 1rem; border-bottom: 1px solid var(--border-color); }
    .activity-header h3 { margin: 0; font-size: 1rem; font-weight: 600; }
    .activity-list { padding: 0.5rem; overflow-y: auto; flex: 1; }
    .activity-empty { color: var(--text-muted); text-align: center; padding: 2rem 1rem; font-size: 0.9rem; }
    .activity-item { display: flex; gap: 0.75rem; padding: 0.75rem; border-radius: 8px; transition: background 0.2s; }
    .activity-item:hover { background: var(--bg-secondary); }
    .activity-icon { font-size: 1.1rem; flex-shrink: 0; }
    .activity-content { flex: 1; min-width: 0; }
    .activity-message { font-size: 0.85rem; margin: 0 0 0.25rem 0; line-height: 1.4; }
    .activity-time { font-size: 0.75rem; color: var(--text-muted); }
    
    @media (max-width: 1024px) {
      .activity-sidebar { position: fixed; right: 0; top: 70px; height: calc(100vh - 70px); max-height: none; border-radius: 12px 0 0 12px; z-index: 100; }
    }
    
    @media (max-width: 768px) {
      .header { padding: 0.75rem 1rem; flex-wrap: wrap; gap: 0.75rem; }
      .logo { font-size: 1.1rem; }
      .nav { order: 3; width: 100%; justify-content: center; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.25rem; }
      .nav-link { padding: 0.4rem 0.6rem; font-size: 0.8rem; white-space: nowrap; }
      .main { padding: 1rem; }
      .page-title { font-size: 1.5rem; }
      .page-subtitle { font-size: 0.85rem; }
      .market-grid { grid-template-columns: 1fr; }
      .stats-row { flex-direction: column; gap: 1rem; }
      .profile-header { flex-direction: column; text-align: center; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .activity-sidebar { width: 280px; }
      .category-filters { gap: 0.4rem; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 0.25rem; }
      .category-pill { padding: 0.4rem 0.75rem; font-size: 0.75rem; white-space: nowrap; flex-shrink: 0; }
      .market-card { padding: 1rem; }
      .market-title { font-size: 0.9rem; }
      .btn-bet { padding: 0.6rem; font-size: 0.85rem; }
      .header-right { gap: 0.5rem; }
      .balance-btn { padding: 0.4rem 0.6rem; font-size: 0.8rem; }
      .user-avatar { width: 32px; height: 32px; }
      .user-btn { padding: 0.3rem; font-size: 0.75rem; }
      .leaderboard-row { padding: 0.75rem; }
      .pending-item { flex-direction: column; gap: 0.75rem; align-items: flex-start; }
      .pending-actions { width: 100%; display: flex; gap: 0.5rem; }
      .pending-actions .btn-sm { flex: 1; justify-content: center; }
      .history-card { padding: 1rem; }
      .history-header { flex-direction: column; gap: 0.5rem; }
      .form-input, .form-textarea { font-size: 16px; } /* Prevent iOS zoom */
      .modal-content { margin: 0.5rem; max-height: 90vh; }
      .confirm-modal { margin: 1rem; padding: 1.25rem; }
    }
    
    @media (max-width: 480px) {
      .nav { gap: 0.25rem; }
      .nav-link { padding: 0.35rem 0.5rem; font-size: 0.75rem; }
      .stats-grid { grid-template-columns: 1fr; }
      .admin-section-title { font-size: 1rem; }
    }
    
    /* Skeleton Loaders */
    @keyframes skeleton-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }
    .skeleton { background: var(--bg-secondary); border-radius: 8px; animation: skeleton-pulse 1.5s ease-in-out infinite; }
    .skeleton-card { height: 180px; border-radius: 12px; }
    .skeleton-row { height: 60px; border-radius: 8px; margin-bottom: 0.75rem; }
    .skeleton-text { height: 1rem; border-radius: 4px; margin-bottom: 0.5rem; }
    .skeleton-text.short { width: 40%; }
    .skeleton-text.medium { width: 70%; }
    .skeleton-avatar { width: 40px; height: 40px; border-radius: 50%; }
    .skeleton-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect, createContext, useContext } = React;

    // Supabase Configuration
    const SUPABASE_URL = 'https://dopwnybfryhmxrrxrkdn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRvcHdueWJmcnlobXhycnhya2RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjk5NjUsImV4cCI6MjA4NDYwNTk2NX0.J2h-7jK6B5yjI5_m90_guM-Q8RzufpLPu2Td19ILfco';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const AppContext = createContext();
    const categories = ["All", "Price", "Events", "Other"];

    const getTodayDate = () => {
      const today = new Date();
      today.setDate(today.getDate() + 1);
      return today.toISOString().split('T')[0];
    };

    const formatDate = (dateStr) => {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' });
    };

    const formatTimeAgo = (dateStr) => {
      const now = new Date();
      const date = new Date(dateStr);
      const seconds = Math.floor((now - date) / 1000);
      
      if (seconds < 60) return 'just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      if (days < 7) return `${days}d ago`;
      return formatDate(dateStr);
    };

    const formatCountdown = (dateStr) => {
      const now = new Date();
      const end = new Date(dateStr);
      const diff = end - now;
      
      if (diff <= 0) return { text: 'Ended', urgent: true };
      
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      
      if (days > 7) return { text: `${days}d left`, urgent: false };
      if (days > 0) return { text: `${days}d ${hours}h left`, urgent: days <= 1 };
      if (hours > 0) return { text: `${hours}h ${minutes}m left`, urgent: true };
      return { text: `${minutes}m left`, urgent: true };
    };

    // Discord Webhooks
    const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1465853567393857649/o9dWL1qW3zBEVWWJvpkivWQfGKRGP27fDTEz80nZZafNLgzbUeZgu9K0bvp1mtrxiXsf';
    const DISCORD_ADMIN_WEBHOOK_URL = 'https://discord.com/api/webhooks/1466541200499675156/azJmBD8gAYmRm18Ya6w87-pZQjI9uJHWUCZwKJ5HjGsMropu9vQdC2HE_8uNiWHj5q2J';
    
    const sendDiscordNotification = async (content, embed = null, useAdmin = false) => {
      try {
        const payload = { content };
        if (embed) {
          payload.embeds = [embed];
          delete payload.content;
        }
        await fetch(useAdmin ? DISCORD_ADMIN_WEBHOOK_URL : DISCORD_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.error('Discord webhook error:', err);
      }
    };

    // Skeleton Loaders
    function SkeletonCard() {
      return <div className="skeleton skeleton-card"></div>;
    }
    
    function SkeletonRow() {
      return <div className="skeleton skeleton-row"></div>;
    }
    
    function MarketsSkeleton() {
      return (
        <main className="main">
          <div className="skeleton skeleton-text medium" style={{ height: '2rem', marginBottom: '0.5rem' }}></div>
          <div className="skeleton skeleton-text short" style={{ marginBottom: '1.5rem' }}></div>
          <div className="skeleton skeleton-text" style={{ width: '100%', height: '3rem', marginBottom: '1rem' }}></div>
          <div className="skeleton skeleton-text" style={{ width: '60%', height: '2.5rem', marginBottom: '1.5rem' }}></div>
          <div className="skeleton-grid">
            <SkeletonCard />
            <SkeletonCard />
            <SkeletonCard />
            <SkeletonCard />
            <SkeletonCard />
            <SkeletonCard />
          </div>
        </main>
      );
    }
    
    function LeaderboardSkeleton() {
      return (
        <main className="main">
          <div className="skeleton skeleton-text medium" style={{ height: '2rem', marginBottom: '0.5rem' }}></div>
          <div className="skeleton skeleton-text short" style={{ marginBottom: '1.5rem' }}></div>
          <div className="leaderboard">
            <div className="skeleton skeleton-text" style={{ height: '2.5rem', marginBottom: '1rem' }}></div>
            <SkeletonRow />
            <SkeletonRow />
            <SkeletonRow />
            <SkeletonRow />
            <SkeletonRow />
          </div>
        </main>
      );
    }

    function Toast({ message, type, onClose }) {
      useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
      return (<div className={`toast toast-${type}`}><span className="toast-icon">{type === 'success' ? '‚úì' : '‚úó'}</span><span>{message}</span></div>);
    }

    function ConfirmModal({ title, message, details, onConfirm, onCancel, confirmText = "Confirm", cancelText = "Cancel", icon = "‚ö†Ô∏è", warning }) {
      return (
        <div className="modal-overlay" onClick={onCancel}>
          <div className="confirm-modal" onClick={e => e.stopPropagation()}>
            <div className="confirm-icon">{icon}</div>
            <h2 className="confirm-title">{title}</h2>
            <p className="confirm-message">{message}</p>
            {details && (
              <div className="confirm-details">
                {details.map((detail, i) => (
                  <div key={i} className="confirm-detail-row">
                    <span className="confirm-detail-label">{detail.label}</span>
                    <span className={`confirm-detail-value ${detail.className || ''}`}>{detail.value}</span>
                  </div>
                ))}
              </div>
            )}
            <div className="confirm-buttons">
              <button className="btn btn-secondary" onClick={onCancel}>{cancelText}</button>
              <button className="btn btn-primary" style={{width: 'auto'}} onClick={onConfirm}>{confirmText}</button>
            </div>
            {warning && <p className="confirm-warning">{warning}</p>}
          </div>
        </div>
      );
    }

    function DiscordIcon() {
      return (
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
        </svg>
      );
    }

    function Login({ onLoginSuccess }) {
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleDiscordLogin = async () => {
        setLoading(true);
        setError('');

        try {
          const { error } = await supabase.auth.signInWithOAuth({
            provider: 'discord',
            options: {
              redirectTo: window.location.origin,
              scopes: 'identify email guilds'
            }
          });

          if (error) throw error;
        } catch (err) {
          console.error('Discord login error:', err);
          setError('Failed to login with Discord. Please try again.');
          setLoading(false);
        }
      };

      return (
        <div className="login-container">
          <div className="login-card">
            <div className="logo" style={{ justifyContent: 'center', marginBottom: '1.5rem', fontSize: '2rem' }}>
              <span className="logo-otc">OTC</span><span className="logo-fi">fi</span><span className="logo-pulse">Pulse</span>
            </div>
            <p className="login-subtitle">Predict OTC stock outcomes. Free bets during alpha! Connect with Discord to get started.</p>
            {error && <p style={{ color: 'var(--accent-red)', marginBottom: '1rem', fontSize: '0.9rem' }}>{error}</p>}
            <button className="discord-btn" onClick={handleDiscordLogin} disabled={loading}>
              <DiscordIcon />
              {loading ? 'Connecting...' : 'Continue with Discord'}
            </button>
          </div>
        </div>
      );
    }

    function Header({ user, activePage, setActivePage, onLogout, onViewProfile }) {
      const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
      const avatarUrl = user.custom_avatar_url || user.avatar_url || user.user_metadata?.avatar_url;
      const displayName = user.display_name || user.username || user.user_metadata?.full_name || user.user_metadata?.name || 'User';

      return (
        <>
          <header className="header">
            <div className="logo"><span className="logo-otc">OTC</span><span className="logo-fi">fi</span><span className="logo-pulse">Pulse</span></div>
            <nav className="nav">
              <button className={`nav-link ${activePage === 'markets' ? 'active' : ''}`} onClick={() => setActivePage('markets')}>Markets</button>
              <button className={`nav-link ${activePage === 'history' ? 'active' : ''}`} onClick={() => setActivePage('history')}>History</button>
              <button className={`nav-link ${activePage === 'portfolio' ? 'active' : ''}`} onClick={() => setActivePage('portfolio')}>Portfolio</button>
              <button className={`nav-link ${activePage === 'leaderboard' ? 'active' : ''}`} onClick={() => setActivePage('leaderboard')}>Leaderboard</button>
              {user.is_admin && <button className={`nav-link ${activePage === 'admin' ? 'active' : ''}`} onClick={() => setActivePage('admin')}>Admin</button>}
            </nav>
            <div className="header-right">
              <button 
                className="profile-btn" 
                onClick={() => onViewProfile(user.id)}
                style={{ 
                  display: 'flex', 
                  alignItems: 'center', 
                  gap: '0.5rem', 
                  background: 'var(--bg-secondary)', 
                  border: '1px solid var(--border)', 
                  borderRadius: '20px', 
                  padding: '0.35rem 0.75rem 0.35rem 0.35rem',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
              >
                <div className="user-avatar" style={{ width: '28px', height: '28px', margin: 0 }}>
                  {avatarUrl ? <img src={avatarUrl} alt="Avatar" /> : 'üë§'}
                </div>
                <span style={{ color: 'var(--text-primary)', fontWeight: 500, fontSize: '0.9rem' }}>{displayName}</span>
              </button>
              <button className="user-btn" onClick={() => setShowLogoutConfirm(true)} title="Logout">‚ùå</button>
            </div>
          </header>
          
          {showLogoutConfirm && (
            <ConfirmModal
              icon="‚ùå"
              title="Log Out?"
              message="Are you sure you want to log out of OTCfi Pulse?"
              confirmText="Log Out"
              cancelText="Stay"
              onConfirm={onLogout}
              onCancel={() => setShowLogoutConfirm(false)}
            />
          )}
        </>
      );
    }

    function MarketCard({ market, onClick }) {
      const [countdown, setCountdown] = useState(formatCountdown(market.ends_at));
      
      useEffect(() => {
        const timer = setInterval(() => {
          setCountdown(formatCountdown(market.ends_at));
        }, 60000); // Update every minute
        return () => clearInterval(timer);
      }, [market.ends_at]);

      return (
        <div className="market-card" onClick={() => onClick(market)}>
          <div className="market-header">
            <div className="market-ticker-row">
              {market.ticker && <span className="ticker-badge">{market.ticker}</span>}
              {market.company && <span className="market-company">{market.company}</span>}
              <span className="category-badge">{market.category}</span>
            </div>
            <span className={`countdown-badge ${countdown.urgent ? 'urgent' : ''}`}>‚è± {countdown.text}</span>
          </div>
          <h3 className="market-title">{market.title}</h3>
          <div className="market-footer">
            <div className="market-meta"><span>Vol: {market.volume?.toLocaleString() || 0}</span></div>
            <div className="market-odds"><span className="odds-pill odds-yes">Yes {market.yes_percent}%</span><span className="odds-pill odds-no">No {market.no_percent}%</span></div>
          </div>
        </div>
      );
    }

    function MarketDetail({ market, onClose, onBet, weeklyBetUsed, userBet }) {
      const [selectedSide, setSelectedSide] = useState('yes');
      const [showConfirm, setShowConfirm] = useState(false);
      const [countdown, setCountdown] = useState(formatCountdown(market.ends_at));
      const isPriceMarket = market.category === 'Price';

      useEffect(() => {
        const timer = setInterval(() => {
          setCountdown(formatCountdown(market.ends_at));
        }, 60000);
        return () => clearInterval(timer);
      }, [market.ends_at]);

      const handleConfirmWager = () => {
        onBet(market.id, selectedSide);
        setShowConfirm(false);
      };

      return (
        <>
          <div className="modal-overlay" onClick={onClose}>
            <div className="modal-content" onClick={e => e.stopPropagation()}>
              <div className="modal-header">
                <button className="back-link" onClick={onClose}>‚Üê Back to markets</button>
                <div className="detail-header">
                  <div className="detail-ticker">{market.ticker || market.category.charAt(0)}</div>
                  <div className="detail-info">
                    <h2>{market.company || market.category}</h2>
                    <h1>{market.title}</h1>
                  </div>
                </div>
                <div className="detail-tags">
                  {market.ticker && <span className="detail-tag">Ticker: {market.ticker}</span>}
                  {market.company && <span className="detail-tag">Company: {market.company}</span>}
                  <span className="detail-tag">Category: {market.category}</span>
                  <span className={`detail-tag ${countdown.urgent ? 'tag-urgent' : ''}`}>‚è± {countdown.text}</span>
                  <span className="detail-tag">Volume: {market.volume?.toLocaleString() || 0}</span>
                </div>
              </div>
              <div className="detail-body">
                <p className="resolution-text">{market.resolution}</p>
                <div className="market-odds-section">
                  <h3 className="market-odds-title">Market Odds</h3>
                  <div className="odds-display">
                    <div className="odds-box"><div className="odds-box-label">Yes</div><div className="odds-box-value yes">{market.yes_percent}%</div></div>
                    <div className="odds-box"><div className="odds-box-label">No</div><div className="odds-box-value no">{market.no_percent}%</div></div>
                  </div>
                </div>
                <div className="wager-section">
                  <h3 className="wager-title">Place Wager</h3>
                  <p className="wager-balance">{weeklyBetUsed ? <span className="bet-status-badge bet-used">Weekly bet used</span> : <span className="bet-status-badge bet-available">1 free bet available this week</span>}</p>
                  {userBet ? (
                    <div className="already-bet-notice">You already bet <strong>{userBet.side.toUpperCase()}</strong> on this market. Good luck! üéØ</div>
                  ) : (
                    <>
                      <div className="bet-buttons">
                        <button className={`bet-btn bet-btn-yes ${selectedSide === 'yes' ? 'selected' : ''}`} onClick={() => setSelectedSide('yes')} disabled={weeklyBetUsed}>Bet YES</button>
                        <button className={`bet-btn bet-btn-no ${selectedSide === 'no' ? 'selected' : ''}`} onClick={() => setSelectedSide('no')} disabled={weeklyBetUsed}>Bet NO</button>
                      </div>
                      <div className="wager-info">
                        <div className="wager-info-row"><span className="wager-info-label">Selected side</span><span className={`wager-info-value ${selectedSide}`}>{selectedSide.toUpperCase()}</span></div>
                      </div>
                      <button className="place-wager-btn" onClick={() => setShowConfirm(true)} disabled={weeklyBetUsed}>Place Wager</button>
                    </>
                  )}
                  <p className="demo-notice">üöÄ Alpha Phase: Free bets! 1 bet per week.</p>
                </div>
              </div>
            </div>
          </div>

          {showConfirm && (
            <ConfirmModal
              icon="üéØ"
              title="Confirm Your Wager"
              message="Are you sure you want to place this bet? This will use your weekly wager."
              details={[
                { label: "Market", value: market.title.length > 40 ? market.title.substring(0, 40) + '...' : market.title },
                { label: "Your Pick", value: selectedSide.toUpperCase(), className: selectedSide }
              ]}
              warning="‚ö†Ô∏è You can only place 1 bet per week"
              confirmText="Place Wager"
              onConfirm={handleConfirmWager}
              onCancel={() => setShowConfirm(false)}
            />
          )}
        </>
      );
    }

    function CreateModal({ onClose, onSubmit, user }) {
      const [category, setCategory] = useState('Price');
      const [title, setTitle] = useState('');
      const [ticker, setTicker] = useState('');
      const [company, setCompany] = useState('');
      const [endsAt, setEndsAt] = useState('');
      const [showConfirm, setShowConfirm] = useState(false);
      const [showCloseConfirm, setShowCloseConfirm] = useState(false);
      const [loading, setLoading] = useState(false);
      const [noTicker, setNoTicker] = useState(false);

      const isPriceCategory = category === 'Price';
      const minDate = getTodayDate();
      const hasContent = title || ticker || company || endsAt;

      // Auto-format ticker (remove $ and spaces, uppercase)
      const handleTickerChange = (e) => {
        const value = e.target.value.replace(/[$\s]/g, '').toUpperCase();
        setTicker(value);
      };

      const handleClose = () => {
        if (hasContent) {
          setShowCloseConfirm(true);
        } else {
          onClose();
        }
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        setShowConfirm(true);
      };

      const handleConfirmSubmit = async () => {
        setLoading(true);
        const data = {
          title,
          category,
          ticker: noTicker ? null : ticker.toUpperCase() || null,
          company: noTicker ? null : company || null,
          ends_at: endsAt,
          created_by: user.id
        };
        await onSubmit(data);
        setShowConfirm(false);
        setLoading(false);
        onClose();
      };

      const formattedDate = endsAt ? new Date(endsAt).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : '';

      return (
        <>
          <div className="modal-overlay" onClick={handleClose}>
            <div className="create-modal" onClick={e => e.stopPropagation()}>
              <div className="create-modal-header">
                <h2 className="create-modal-title">Suggest a Prediction</h2>
                <button className="close-btn" onClick={handleClose}>√ó</button>
              </div>
              <form onSubmit={handleSubmit}>
                <div className="create-modal-body">
                  <div className="form-group">
                    <label className="form-label">Category</label>
                    <div className="category-select-group">
                      {['Price', 'Events', 'Other'].map(cat => (
                        <button key={cat} type="button" className={`category-select-btn ${category === cat ? 'active' : ''}`} onClick={() => setCategory(cat)}>{cat}</button>
                      ))}
                    </div>
                  </div>
                  <div className="form-group">
                    <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer', fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                      <input type="checkbox" checked={noTicker} onChange={(e) => setNoTicker(e.target.checked)} style={{ width: 'auto' }} />
                      Not tied to a specific ticker
                    </label>
                  </div>
                  {!noTicker && (
                    <>
                      <div className="form-group">
                        <label className="form-label">Ticker Symbol</label>
                        <input type="text" className="form-input" placeholder="e.g., MVCO" value={ticker} onChange={handleTickerChange} maxLength={5} required={!noTicker} />
                      </div>
                      <div className="form-group">
                        <label className="form-label">Company Name</label>
                        <input type="text" className="form-input" placeholder="e.g., Metavesco Inc" value={company} onChange={(e) => setCompany(e.target.value)} required={!noTicker} />
                      </div>
                    </>
                  )}
                  <div className="form-group">
                    <label className="form-label">{isPriceCategory ? 'Prediction Question' : 'Prediction Title'}</label>
                    <textarea className="form-textarea" placeholder={noTicker ? "e.g., Will an OTC company migrate to NASDAQ this month?" : (isPriceCategory ? "e.g., Will MVCO close above $0.01 this week?" : "e.g., New partnership announced this month")} value={title} onChange={(e) => setTitle(e.target.value)} required />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Resolution Date</label>
                    <input type="date" className="form-input" value={endsAt} onChange={(e) => setEndsAt(e.target.value)} min={minDate} required />
                  </div>
                </div>
                <div className="create-modal-footer">
                  <button type="button" className="btn btn-secondary" onClick={handleClose}>Cancel</button>
                  <button type="submit" className="btn btn-primary" style={{width:'auto'}}>Submit for Review</button>
                </div>
              </form>
            </div>
          </div>

          {showConfirm && (
            <ConfirmModal
              icon="üìù"
              title="Submit Prediction?"
              message="Your prediction will be sent to admins for review before going live."
              details={[
                { label: "Category", value: category },
                ...(noTicker ? [] : [
                  { label: "Ticker", value: `$${ticker.toUpperCase()}` },
                  { label: "Company", value: company }
                ]),
                { label: "Prediction", value: title.length > 50 ? title.substring(0, 50) + '...' : title },
                { label: "Resolution Date", value: formattedDate }
              ]}
              confirmText={loading ? "Submitting..." : "Submit Prediction"}
              onConfirm={handleConfirmSubmit}
              onCancel={() => setShowConfirm(false)}
            />
          )}

          {showCloseConfirm && (
            <ConfirmModal
              icon="‚ö†Ô∏è"
              title="Discard Prediction?"
              message="You have unsaved changes. Are you sure you want to close?"
              confirmText="Discard"
              cancelText="Keep Editing"
              onConfirm={onClose}
              onCancel={() => setShowCloseConfirm(false)}
            />
          )}
        </>
      );
    }

    function MarketsPage({ markets, onMarketClick, onCreateClick, weeklyBetUsed, loading, activityLog, showActivity, onToggleActivity, isAdmin, onClearActivity }) {
      const [activeCategory, setActiveCategory] = useState('All');
      const [searchTerm, setSearchTerm] = useState('');
      const [showClearConfirm, setShowClearConfirm] = useState(false);
      const activeMarkets = markets.filter(m => m.status === 'active');
      const filtered = activeMarkets.filter(m => {
        const matchesCategory = activeCategory === 'All' || m.category === activeCategory;
        const matchesSearch = searchTerm === '' || 
          m.ticker?.toLowerCase().includes(searchTerm.toLowerCase()) ||
          m.company?.toLowerCase().includes(searchTerm.toLowerCase()) ||
          m.title?.toLowerCase().includes(searchTerm.toLowerCase());
        return matchesCategory && matchesSearch;
      });
      
      if (loading) {
        return <MarketsSkeleton />;
      }

      return (
        <main className="main">
          <div className="markets-layout">
            <div className="markets-content">
              <h1 className="page-title">Trade OTC Stock Outcomes</h1>
              <p className="page-subtitle">Predict price movements, events, and more. Compete for the top of the leaderboard!</p>
              <div className="stats-row">
                <div style={{ display: 'flex', gap: '2rem', alignItems: 'center' }}>
                  <div className="alpha-badge">üöÄ Free Alpha</div>
                  <div className="stat-group"><span className="stat-label">Weekly Bet</span><span className={`bet-status-badge ${weeklyBetUsed ? 'bet-used' : 'bet-available'}`}>{weeklyBetUsed ? '‚úó Used' : '‚úì Available'}</span></div>
                </div>
                <div style={{ display: 'flex', gap: '0.75rem' }}>
                  <button className="suggest-btn" onClick={onCreateClick}>+ Suggest Prediction</button>
                  <button className="activity-toggle-btn" onClick={onToggleActivity}>{showActivity ? '‚úï' : 'üì¢'}</button>
                </div>
              </div>
              <div style={{ display: 'flex', gap: '1rem', alignItems: 'center', marginBottom: '1rem', flexWrap: 'wrap' }}>
                <input 
                  type="text" 
                  className="form-input" 
                  placeholder="Search by ticker, company, or title..." 
                  value={searchTerm} 
                  onChange={(e) => setSearchTerm(e.target.value)}
                  style={{ flex: 1, minWidth: '200px', maxWidth: '300px' }}
                />
                <div className="category-filters" style={{ marginBottom: 0 }}>{categories.map(cat => <button key={cat} className={`category-pill ${activeCategory === cat ? 'active' : ''}`} onClick={() => setActiveCategory(cat)}>{cat}</button>)}</div>
              </div>
              <div className="market-grid">{filtered.map(market => <MarketCard key={market.id} market={market} onClick={onMarketClick} />)}</div>
              {filtered.length === 0 && <div className="empty-state"><div className="empty-state-icon">üìä</div><div className="empty-state-title">No markets found</div><p>Try a different search or category.</p></div>}
            </div>
            {showActivity && (
              <div className="activity-sidebar">
                <div className="activity-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <h3>üì¢ Activity Feed</h3>
                  {isAdmin && activityLog.length > 0 && (
                    <button 
                      onClick={() => setShowClearConfirm(true)} 
                      style={{ background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '0.75rem', padding: '0.25rem' }}
                      title="Clear activity feed"
                    >
                      üóëÔ∏è
                    </button>
                  )}
                </div>
                <div className="activity-list">
                  {activityLog.length === 0 ? (
                    <p className="activity-empty">No recent activity</p>
                  ) : (
                    activityLog.slice(0, 5).map(activity => (
                      <div key={activity.id} className="activity-item">
                        <span className="activity-icon">
                          {activity.type === 'resolve' && '‚úÖ'}
                          {activity.type === 'new_market' && 'üìã'}
                        </span>
                        <div className="activity-content">
                          <p className="activity-message">{activity.message}</p>
                          <span className="activity-time">{formatTimeAgo(activity.created_at)}</span>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            )}
            {showClearConfirm && (
              <ConfirmModal
                icon="üóëÔ∏è"
                title="Clear Activity Feed?"
                message="This will delete all activity feed entries."
                warning="This action cannot be undone."
                confirmText="Clear All"
                onConfirm={() => { onClearActivity(); setShowClearConfirm(false); }}
                onCancel={() => setShowClearConfirm(false)}
              />
            )}
          </div>
        </main>
      );
    }

    function PortfolioPage({ userBets, markets }) {
      const userMarkets = markets.filter(m => userBets.find(b => b.market_id === m.id));
      return (
        <main className="main">
          <h1 className="page-title">Portfolio</h1>
          <p className="page-subtitle">Track your active predictions and past performance.</p>
          {userMarkets.length === 0 ? (
            <div className="empty-state"><div className="empty-state-icon">üìà</div><div className="empty-state-title">No positions yet</div><p>Click a market to place your first trade.</p></div>
          ) : (
            <><h2 style={{ marginBottom: '1rem', fontSize: '1.1rem' }}>Open Positions</h2>
            <div className="market-grid">{userMarkets.map(market => {
              const bet = userBets.find(b => b.market_id === market.id);
              const countdown = formatCountdown(market.ends_at);
              return (
                <div key={market.id} className="market-card">
                  <div className="market-header">
                    <div className="market-ticker-row">
                      {market.ticker && <span className="ticker-badge">{market.ticker}</span>}
                      {market.company && <span className="market-company">{market.company}</span>}
                      <span className="category-badge">{market.category}</span>
                    </div>
                    <span className={`bet-status-badge ${bet?.side === 'yes' ? 'bet-available' : 'bet-used'}`}>{bet?.side?.toUpperCase()}</span>
                  </div>
                  <h3 className="market-title">{market.title}</h3>
                  <div className="market-footer"><div className="market-meta"><span className={countdown.urgent ? 'countdown-text-urgent' : ''}>‚è± {countdown.text}</span></div></div>
                </div>
              );
            })}</div></>
          )}
        </main>
      );
    }

    function HistoryPage({ markets, loading, isAdmin, onClearHistory }) {
      const [searchTerm, setSearchTerm] = useState('');
      const [filterCategory, setFilterCategory] = useState('All');
      const [showClearConfirm, setShowClearConfirm] = useState(false);
      
      const resolvedMarkets = markets
        .filter(m => m.status === 'resolved')
        .sort((a, b) => new Date(b.resolved_at) - new Date(a.resolved_at));
      
      const filtered = resolvedMarkets.filter(m => {
        const matchesCategory = filterCategory === 'All' || m.category === filterCategory;
        const matchesSearch = searchTerm === '' || 
          m.ticker?.toLowerCase().includes(searchTerm.toLowerCase()) ||
          m.company?.toLowerCase().includes(searchTerm.toLowerCase()) ||
          m.title?.toLowerCase().includes(searchTerm.toLowerCase());
        return matchesCategory && matchesSearch;
      });

      if (loading) {
        return <LeaderboardSkeleton />;
      }

      return (
        <main className="main">
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '0.5rem', flexWrap: 'wrap', gap: '1rem' }}>
            <div>
              <h1 className="page-title" style={{ marginBottom: '0.25rem' }}>Market History</h1>
              <p className="page-subtitle" style={{ marginBottom: 0 }}>View all resolved markets and their outcomes.</p>
            </div>
            {isAdmin && resolvedMarkets.length > 0 && (
              <button className="btn btn-secondary" onClick={() => setShowClearConfirm(true)} style={{ fontSize: '0.85rem' }}>
                üóëÔ∏è Clear History
              </button>
            )}
          </div>
          
          <div style={{ display: 'flex', gap: '1rem', alignItems: 'center', marginBottom: '1.5rem', flexWrap: 'wrap', marginTop: '1rem' }}>
            <input 
              type="text" 
              className="form-input" 
              placeholder="Search resolved markets..." 
              value={searchTerm} 
              onChange={(e) => setSearchTerm(e.target.value)}
              style={{ flex: 1, minWidth: '200px', maxWidth: '300px' }}
            />
            <div className="category-filters" style={{ marginBottom: 0 }}>
              {categories.map(cat => (
                <button 
                  key={cat} 
                  className={`category-pill ${filterCategory === cat ? 'active' : ''}`} 
                  onClick={() => setFilterCategory(cat)}
                >
                  {cat}
                </button>
              ))}
            </div>
          </div>

          {filtered.length === 0 ? (
            <div className="empty-state">
              <div className="empty-state-icon">üìú</div>
              <div className="empty-state-title">No resolved markets</div>
              <p>Markets will appear here once they're resolved.</p>
            </div>
          ) : (
            <div className="history-list">
              {filtered.map(market => (
                <div key={market.id} className="history-card">
                  <div className="history-header">
                    <div className="history-ticker-row">
                      {market.ticker && <span className="history-ticker">${market.ticker}</span>}
                      <span className={`history-result ${market.winner === 'yes' ? 'result-yes' : 'result-no'}`}>
                        {market.winner === 'yes' ? '‚úì YES Won' : '‚úó NO Won'}
                      </span>
                    </div>
                    <span className="history-date">Resolved {formatDate(market.resolved_at)}</span>
                  </div>
                  <div className="history-title">{market.title}</div>
                  <div className="history-meta">
                    <span className="history-category">{market.category}</span>
                    <span className="history-volume">{(market.volume || 0).toLocaleString()} volume</span>
                  </div>
                </div>
              ))}
            </div>
          )}

          {showClearConfirm && (
            <ConfirmModal
              icon="üóëÔ∏è"
              title="Clear Market History?"
              message={`This will delete all ${resolvedMarkets.length} resolved markets. User stats (wins/losses) will be preserved.`}
              warning="This action cannot be undone."
              confirmText="Clear All"
              onConfirm={() => { onClearHistory(); setShowClearConfirm(false); }}
              onCancel={() => setShowClearConfirm(false)}
            />
          )}
        </main>
      );
    }

    function LeaderboardPage({ leaderboard, onViewProfile, loading }) {
      if (loading) {
        return <LeaderboardSkeleton />;
      }

      return (
        <main className="main">
          <h1 className="page-title">Leaderboard</h1>
          <p className="page-subtitle">Top predictors ranked by correct predictions.</p>
          <div className="leaderboard">
            <div className="leaderboard-header">üèÜ Top Predictors</div>
            {leaderboard.length === 0 ? (
              <div className="leaderboard-row"><span style={{ color: 'var(--text-muted)' }}>No winners yet. Be the first to get a prediction right!</span></div>
            ) : (
              leaderboard.map((user, i) => (
                <div key={user.id} className="leaderboard-row" onClick={() => onViewProfile(user.id)} style={{ cursor: 'pointer' }}>
                  <span className={`leaderboard-rank ${i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : ''}`}>#{i + 1}</span>
                  <div className="leaderboard-user">
                    <div className="leaderboard-avatar">
                      {(user.custom_avatar_url || user.avatar_url) ? <img src={user.custom_avatar_url || user.avatar_url} alt="" /> : user.username?.substring(0, 2).toUpperCase()}
                    </div>
                    <span className="leaderboard-name">{user.display_name || user.username}</span>
                  </div>
                  <div className="leaderboard-stats">
                    <span className="leaderboard-wins">{user.total_wins || 0} wins</span>
                  </div>
                </div>
              ))
            )}
          </div>
        </main>
      );
    }

    function ProfilePage({ profileUser, currentUser, userBets, markets, onUpdateProfile, onViewProfile, pendingPredictions, loading }) {
      const [walletAddress, setWalletAddress] = useState(profileUser?.wallet_address || '');
      const [displayName, setDisplayName] = useState(profileUser?.display_name || '');
      const [customAvatarUrl, setCustomAvatarUrl] = useState(profileUser?.custom_avatar_url || '');
      const [profilePrivate, setProfilePrivate] = useState(profileUser?.profile_private || false);
      const [historyPrivate, setHistoryPrivate] = useState(profileUser?.betting_history_private || false);
      const [historyFilter, setHistoryFilter] = useState('all');
      const [saving, setSaving] = useState(false);
      const [saved, setSaved] = useState(false);

      const isOwnProfile = currentUser.id === profileUser?.id;
      const isAdmin = currentUser.is_admin;
      const canSeePrivate = isOwnProfile || isAdmin;

      // Calculate stats
      const totalBets = profileUser?.total_bets || 0;
      const totalWins = profileUser?.total_wins || 0;
      const winRate = totalBets > 0 ? Math.round((totalWins / totalBets) * 100) : 0;

      // Get user's betting history
      const userMarketBets = userBets
        .filter(b => isOwnProfile ? true : b.user_id === profileUser?.id)
        .map(bet => {
          const market = markets.find(m => m.id === bet.market_id);
          return { ...bet, market };
        })
        .filter(b => b.market);

      // Get user's submission history
      const userSubmissions = (pendingPredictions || []).filter(p => p.created_by === profileUser?.id);

      const filteredHistory = userMarketBets.filter(bet => {
        if (historyFilter === 'all') return true;
        if (historyFilter === 'wins') return bet.result === 'won';
        if (historyFilter === 'losses') return bet.result === 'lost';
        if (historyFilter === 'pending') return !bet.result;
        return true;
      });

      const handleSave = async () => {
        setSaving(true);
        await onUpdateProfile({
          wallet_address: walletAddress,
          display_name: displayName || null,
          custom_avatar_url: customAvatarUrl || null,
          profile_private: profilePrivate,
          betting_history_private: historyPrivate
        });
        setSaving(false);
        setSaved(true);
        setTimeout(() => setSaved(false), 2000);
      };

      const formatJoinDate = (date) => {
        if (!date) return 'Unknown';
        return new Date(date).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      };

      const avatarUrl = profileUser?.custom_avatar_url || profileUser?.avatar_url;
      const shownDisplayName = profileUser?.display_name || profileUser?.username;

      if (loading || !profileUser) {
        return <main className="main"><div className="loading"><div className="loading-spinner">‚ü≥</div><p>Loading profile...</p></div></main>;
      }

      // Check if profile is private
      if (profileUser.profile_private && !canSeePrivate) {
        return (
          <main className="main">
            <div className="profile-header">
              <div className="profile-avatar-large">
                {avatarUrl ? <img src={avatarUrl} alt="" /> : profileUser.username?.substring(0, 2).toUpperCase()}
              </div>
              <div className="profile-info">
                <h1 className="profile-username">{shownDisplayName}</h1>
                {profileUser.display_name && <p style={{ color: 'var(--text-muted)', fontSize: '0.85rem' }}>@{profileUser.username}</p>}
                <p className="profile-private-notice">üîí This profile is private</p>
              </div>
            </div>
            <div className="profile-section">
              <h3 className="profile-section-title">üìä Public Stats</h3>
              <div className="stats-grid">
                <div className="stat-card"><div className="stat-card-value">{profileUser.total_wins || 0}</div><div className="stat-card-label">Total Wins</div></div>
              </div>
            </div>
          </main>
        );
      }

      return (
        <main className="main">
          <div className="profile-header">
            <div className="profile-avatar-large">
              {avatarUrl ? <img src={avatarUrl} alt="" /> : profileUser.username?.substring(0, 2).toUpperCase()}
            </div>
            <div className="profile-info">
              <h1 className="profile-username">
                {shownDisplayName}
                {profileUser.is_admin && <span className="admin-badge">ADMIN</span>}
              </h1>
              {profileUser.display_name && <p style={{ color: 'var(--text-muted)', fontSize: '0.85rem', marginTop: '0.25rem' }}>@{profileUser.username}</p>}
              <p className="profile-joined">Member since {formatJoinDate(profileUser.created_at)}</p>
            </div>
          </div>

          <div className="profile-section">
            <h3 className="profile-section-title">üìä Stats</h3>
            <div className="stats-grid">
              <div className="stat-card"><div className="stat-card-value">{totalWins}</div><div className="stat-card-label">Total Wins</div></div>
              <div className="stat-card"><div className="stat-card-value">{winRate}%</div><div className="stat-card-label">Win Rate</div></div>
              <div className="stat-card"><div className="stat-card-value">{totalBets}</div><div className="stat-card-label">Total Bets</div></div>
              <div className="stat-card"><div className="stat-card-value">{profileUser.current_streak || 0}</div><div className="stat-card-label">Current Streak</div></div>
              <div className="stat-card"><div className="stat-card-value">{profileUser.best_streak || 0}</div><div className="stat-card-label">Best Streak</div></div>
            </div>
          </div>

          {isOwnProfile && (
            <div className="profile-section">
              <h3 className="profile-section-title">‚ú® Customize Profile</h3>
              <div className="form-group">
                <label className="form-label">Display Name</label>
                <input 
                  type="text" 
                  className="form-input" 
                  placeholder="Leave blank to use Discord name" 
                  value={displayName} 
                  onChange={(e) => setDisplayName(e.target.value)}
                  maxLength={20}
                />
                <p style={{ color: 'var(--text-muted)', fontSize: '0.75rem', marginTop: '0.25rem' }}>Your Discord username (@{profileUser.username}) will still be visible</p>
              </div>
              <div className="form-group">
                <label className="form-label">Custom Avatar URL</label>
                <input 
                  type="url" 
                  className="form-input" 
                  placeholder="https://example.com/avatar.png" 
                  value={customAvatarUrl} 
                  onChange={(e) => setCustomAvatarUrl(e.target.value)}
                />
                <p style={{ color: 'var(--text-muted)', fontSize: '0.75rem', marginTop: '0.25rem' }}>Leave blank to use your Discord avatar</p>
              </div>
            </div>
          )}

          {isOwnProfile && (
            <div className="profile-section">
              <h3 className="profile-section-title">üí∞ Wallet Address</h3>
              <p style={{ color: 'var(--text-muted)', fontSize: '0.85rem', marginBottom: '0.75rem' }}>For future payouts. Only visible to you and admins.</p>
              <input 
                type="text" 
                className="form-input" 
                placeholder="Enter your wallet address..." 
                value={walletAddress} 
                onChange={(e) => setWalletAddress(e.target.value)}
              />
            </div>
          )}

          {canSeePrivate && profileUser.wallet_address && !isOwnProfile && (
            <div className="profile-section">
              <h3 className="profile-section-title">üí∞ Wallet Address (Admin View)</h3>
              <p style={{ color: 'var(--text-secondary)', fontFamily: 'monospace', background: 'var(--bg-input)', padding: '0.75rem', borderRadius: '8px' }}>{profileUser.wallet_address}</p>
            </div>
          )}

          {isOwnProfile && (
            <div className="profile-section">
              <h3 className="profile-section-title">üîí Privacy Settings</h3>
              <div className="privacy-toggle">
                <label className="toggle-label">
                  <input type="checkbox" checked={profilePrivate} onChange={(e) => setProfilePrivate(e.target.checked)} />
                  <span className="toggle-text">Make profile private</span>
                </label>
                <p className="toggle-description">Only your username and leaderboard stats will be visible to others</p>
              </div>
              <div className="privacy-toggle">
                <label className="toggle-label">
                  <input type="checkbox" checked={historyPrivate} onChange={(e) => setHistoryPrivate(e.target.checked)} />
                  <span className="toggle-text">Hide betting history</span>
                </label>
                <p className="toggle-description">Others won't see your betting history (admins can still see)</p>
              </div>
              <button className="btn btn-primary" onClick={handleSave} disabled={saving} style={{ marginTop: '1rem' }}>
                {saving ? 'Saving...' : saved ? '‚úì Saved!' : 'Save Changes'}
              </button>
            </div>
          )}

          {isOwnProfile && userSubmissions.length > 0 && (
            <div className="profile-section">
              <h3 className="profile-section-title">üìù My Submissions (Pending)</h3>
              <div className="history-list">
                {userSubmissions.map(sub => (
                  <div key={sub.id} className="history-item">
                    <div className="history-info">
                      <div className="history-market">{sub.ticker && <span className="ticker-badge" style={{ marginRight: '0.5rem' }}>${sub.ticker}</span>}{sub.title}</div>
                      <div className="history-meta">{sub.category} ‚Ä¢ Submitted {formatDate(sub.created_at)}</div>
                    </div>
                    <div className="history-result pending">‚è≥ Pending Review</div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {(canSeePrivate || !profileUser.betting_history_private) && (
            <div className="profile-section">
              <h3 className="profile-section-title">üìú Betting History</h3>
              <div className="history-filters">
                {['all', 'wins', 'losses', 'pending'].map(f => (
                  <button 
                    key={f} 
                    className={`category-pill ${historyFilter === f ? 'active' : ''}`}
                    onClick={() => setHistoryFilter(f)}
                  >
                    {f.charAt(0).toUpperCase() + f.slice(1)}
                  </button>
                ))}
              </div>
              {filteredHistory.length === 0 ? (
                <p style={{ color: 'var(--text-muted)', padding: '1rem 0' }}>No bets found</p>
              ) : (
                <div className="history-list">
                  {filteredHistory.map(bet => (
                    <div key={bet.id} className="history-item">
                      <div className="history-info">
                        <div className="history-market">{bet.market?.ticker && <span className="ticker-badge" style={{ marginRight: '0.5rem' }}>${bet.market.ticker}</span>}{bet.market?.title}</div>
                        <div className="history-meta">Picked: <span className={bet.side === 'yes' ? 'text-green' : 'text-red'}>{bet.side?.toUpperCase()}</span></div>
                      </div>
                      <div className={`history-result ${bet.result || 'pending'}`}>
                        {bet.result === 'won' ? '‚úì Won' : bet.result === 'lost' ? '‚úó Lost' : '‚è≥ Pending'}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </main>
      );
    }

    function AdminPage({ pendingPredictions, onApprove, onReject, onEditPending, markets, onResolve, onEditMarket, allUsers, onToggleAdmin, onBanUser, onUnbanUser, onViewProfile, allBets, loading }) {
      const [userSearch, setUserSearch] = useState('');
      const [banConfirm, setBanConfirm] = useState(null);
      const [editItem, setEditItem] = useState(null);
      const [editType, setEditType] = useState(null); // 'market' or 'pending'
      const [editTitle, setEditTitle] = useState('');
      const [editTicker, setEditTicker] = useState('');
      const [editCompany, setEditCompany] = useState('');
      const [editEndsAt, setEditEndsAt] = useState('');
      const [editCategory, setEditCategory] = useState('');
      
      const activeMarkets = markets.filter(m => m.status === 'active');
      const filteredUsers = allUsers.filter(u => 
        u.username?.toLowerCase().includes(userSearch.toLowerCase()) ||
        u.discord_id?.includes(userSearch)
      );

      // CSV Export functions
      const downloadCSV = (data, filename) => {
        const csv = data.map(row => Object.values(row).map(v => `"${String(v || '').replace(/"/g, '""')}"`).join(',')).join('\n');
        const headers = Object.keys(data[0] || {}).join(',');
        const blob = new Blob([headers + '\n' + csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      };

      const exportUsers = () => {
        const data = allUsers.map(u => ({
          username: u.username,
          discord_id: u.discord_id,
          total_wins: u.total_wins || 0,
          total_bets: u.total_bets || 0,
          is_admin: u.is_admin ? 'Yes' : 'No',
          banned: u.banned ? 'Yes' : 'No',
          wallet_address: u.wallet_address || '',
          created_at: u.created_at
        }));
        downloadCSV(data, `otcfi-users-${new Date().toISOString().split('T')[0]}.csv`);
      };

      const exportMarkets = () => {
        const data = markets.map(m => ({
          ticker: m.ticker || '',
          title: m.title,
          category: m.category,
          status: m.status,
          winner: m.winner || '',
          volume: m.volume || 0,
          yes_percent: m.yes_percent,
          no_percent: m.no_percent,
          ends_at: m.ends_at,
          resolved_at: m.resolved_at || '',
          created_at: m.created_at
        }));
        downloadCSV(data, `otcfi-markets-${new Date().toISOString().split('T')[0]}.csv`);
      };

      const exportBets = () => {
        const data = (allBets || []).map(b => {
          const user = allUsers.find(u => u.id === b.user_id);
          const market = markets.find(m => m.id === b.market_id);
          return {
            username: user?.username || 'Unknown',
            market_ticker: market?.ticker || '',
            market_title: market?.title || 'Unknown',
            side: b.side,
            result: b.result || 'pending',
            created_at: b.created_at
          };
        });
        downloadCSV(data, `otcfi-bets-${new Date().toISOString().split('T')[0]}.csv`);
      };

      const openEditModal = (item, type) => {
        setEditItem(item);
        setEditType(type);
        setEditTitle(item.title);
        setEditTicker(item.ticker || '');
        setEditCompany(item.company || '');
        setEditEndsAt(item.ends_at?.split('T')[0] || '');
        setEditCategory(item.category || '');
      };

      const handleSaveEdit = () => {
        const updates = {
          title: editTitle,
          ticker: editTicker,
          company: editCompany,
          ends_at: editEndsAt,
          category: editCategory
        };
        if (editType === 'market') {
          onEditMarket(editItem.id, updates);
        } else {
          onEditPending(editItem.id, updates);
        }
        setEditItem(null);
        setEditType(null);
      };

      if (loading) {
        return <main className="main"><div className="loading"><div className="loading-spinner">‚ü≥</div><p>Loading admin panel...</p></div></main>;
      }

      return (
        <main className="main">
          <h1 className="page-title">Admin Panel</h1>
          <p className="page-subtitle">Manage predictions, resolve markets, and control user access.</p>
          <div className="admin-section">
            <h3 className="admin-section-title">üìã Pending Predictions ({pendingPredictions.length})</h3>
            {pendingPredictions.length === 0 ? <p style={{ color: 'var(--text-muted)' }}>No pending predictions</p> : pendingPredictions.map(pred => (
              <div key={pred.id} className="pending-item">
                <div className="pending-info">
                  <div className="pending-title">{pred.ticker ? `${pred.ticker} - ` : ''}{pred.title}</div>
                  <div className="pending-meta">{pred.category} ‚Ä¢ Ends {formatDate(pred.ends_at)}</div>
                </div>
                <div className="pending-actions">
                  <button className="btn-sm" style={{ background: 'var(--bg-secondary)', color: 'var(--text-primary)' }} onClick={() => openEditModal(pred, 'pending')}>‚úèÔ∏è Edit</button>
                  <button className="btn-sm btn-approve" onClick={() => onApprove(pred)}>Approve</button>
                  <button className="btn-sm btn-reject" onClick={() => onReject(pred.id)}>Reject</button>
                </div>
              </div>
            ))}
          </div>
          <div className="admin-section">
            <h3 className="admin-section-title">‚úÖ Resolve Active Markets</h3>
            {activeMarkets.length === 0 ? <p style={{ color: 'var(--text-muted)' }}>No active markets</p> : activeMarkets.map(market => (
              <div key={market.id} className="pending-item">
                <div className="pending-info">
                  <div className="pending-title">{market.ticker ? `${market.ticker} - ` : ''}{market.title}</div>
                  <div className="pending-meta">{market.category} ‚Ä¢ Ends {formatDate(market.ends_at)} ‚Ä¢ Vol: {market.volume?.toLocaleString() || 0}</div>
                </div>
                <div className="pending-actions">
                  <button className="btn-sm" style={{ background: 'var(--bg-secondary)', color: 'var(--text-primary)' }} onClick={() => openEditModal(market, 'market')}>‚úèÔ∏è Edit</button>
                  <button className="btn-sm btn-approve" onClick={() => onResolve(market.id, 'yes')}>YES Won</button>
                  <button className="btn-sm btn-reject" onClick={() => onResolve(market.id, 'no')}>NO Won</button>
                </div>
              </div>
            ))}
          </div>
          <div className="admin-section">
            <h3 className="admin-section-title">üë• Manage Users ({allUsers.length})</h3>
            <input 
              type="text" 
              className="form-input" 
              placeholder="Search users..." 
              value={userSearch} 
              onChange={(e) => setUserSearch(e.target.value)}
              style={{ marginBottom: '1rem' }}
            />
            {filteredUsers.length === 0 ? <p style={{ color: 'var(--text-muted)' }}>No users found</p> : filteredUsers.map(u => (
              <div key={u.id} className="pending-item" style={u.banned ? { opacity: 0.6, background: 'rgba(239, 68, 68, 0.1)' } : {}}>
                <div className="pending-info" style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', cursor: 'pointer' }} onClick={() => onViewProfile(u.id)}>
                  <div className="leaderboard-avatar" style={{ width: '32px', height: '32px', borderRadius: '6px', flexShrink: 0 }}>
                    {u.avatar_url ? <img src={u.avatar_url} alt="" style={{ width: '100%', height: '100%', objectFit: 'cover', borderRadius: '6px' }} /> : u.username?.substring(0, 2).toUpperCase()}
                  </div>
                  <div>
                    <div className="pending-title">
                      {u.username} 
                      {u.is_admin && <span style={{ color: 'var(--accent-purple)', fontSize: '0.75rem' }}> ‚Ä¢ ADMIN</span>}
                      {u.banned && <span style={{ color: 'var(--accent-red)', fontSize: '0.75rem' }}> ‚Ä¢ BANNED</span>}
                    </div>
                    <div className="pending-meta">@{u.username} ‚Ä¢ {u.total_wins || 0} wins</div>
                  </div>
                </div>
                <div className="pending-actions">
                  {u.is_admin ? (
                    <button className="btn-sm btn-reject" onClick={() => onToggleAdmin(u.id, false)}>Remove Admin</button>
                  ) : (
                    <button className="btn-sm btn-approve" onClick={() => onToggleAdmin(u.id, true)}>Make Admin</button>
                  )}
                  {u.banned ? (
                    <button className="btn-sm btn-approve" onClick={() => onUnbanUser(u.id)} style={{ marginLeft: '0.5rem' }}>Unban</button>
                  ) : (
                    <button className="btn-sm btn-reject" onClick={() => setBanConfirm(u)} style={{ marginLeft: '0.5rem' }}>Ban</button>
                  )}
                </div>
              </div>
            ))}
          </div>
          
          <div className="admin-section">
            <h3 className="admin-section-title">üìä Export Data</h3>
            <div style={{ display: 'flex', gap: '0.75rem', flexWrap: 'wrap' }}>
              <button className="btn btn-secondary" onClick={exportUsers} style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                üì• Export Users
              </button>
              <button className="btn btn-secondary" onClick={exportMarkets} style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                üì• Export Markets
              </button>
              <button className="btn btn-secondary" onClick={exportBets} style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                üì• Export Bets
              </button>
            </div>
          </div>
          
          {banConfirm && (
            <ConfirmModal
              icon="üö´"
              title="Ban User?"
              message={`Are you sure you want to ban ${banConfirm.username}? They won't be able to log in.`}
              details={[
                { label: "Username", value: banConfirm.username },
                { label: "Wins", value: banConfirm.total_wins || 0 }
              ]}
              warning="This will prevent them from accessing the platform. You can unban them later."
              confirmText="Ban User"
              onConfirm={() => { onBanUser(banConfirm.id); setBanConfirm(null); }}
              onCancel={() => setBanConfirm(null)}
            />
          )}

          {editItem && (
            <div className="modal-overlay" onClick={() => { setEditItem(null); setEditType(null); }}>
              <div className="modal-content" style={{ maxWidth: '500px' }} onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                  <h2 style={{ margin: 0 }}>‚úèÔ∏è Edit {editType === 'market' ? 'Market' : 'Prediction'}</h2>
                </div>
                <div style={{ padding: '1.5rem' }}>
                  <div className="form-group">
                    <label className="form-label">Ticker</label>
                    <input type="text" className="form-input" value={editTicker} onChange={e => setEditTicker(e.target.value)} placeholder="e.g., MVCO" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Company</label>
                    <input type="text" className="form-input" value={editCompany} onChange={e => setEditCompany(e.target.value)} placeholder="e.g., Metavesco Inc" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Title</label>
                    <textarea className="form-textarea" value={editTitle} onChange={e => setEditTitle(e.target.value)} rows={3} />
                  </div>
                  {editType === 'pending' && (
                    <div className="form-group">
                      <label className="form-label">Category</label>
                      <select className="form-input" value={editCategory} onChange={e => setEditCategory(e.target.value)}>
                        {categories.filter(c => c !== 'All').map(cat => (
                          <option key={cat} value={cat}>{cat}</option>
                        ))}
                      </select>
                    </div>
                  )}
                  <div className="form-group">
                    <label className="form-label">End Date</label>
                    <input type="date" className="form-input" value={editEndsAt} onChange={e => setEditEndsAt(e.target.value)} />
                  </div>
                  <div style={{ display: 'flex', gap: '0.75rem', marginTop: '1.5rem' }}>
                    <button className="btn btn-secondary" onClick={() => { setEditItem(null); setEditType(null); }} style={{ flex: 1 }}>Cancel</button>
                    <button className="btn btn-primary" onClick={handleSaveEdit} style={{ flex: 1 }}>Save Changes</button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </main>
      );
    }

    function App() {
      const [session, setSession] = useState(null);
      const [user, setUser] = useState(null);
      const [activePage, setActivePage] = useState('markets');
      const [markets, setMarkets] = useState([]);
      const [leaderboard, setLeaderboard] = useState([]);
      const [pendingPredictions, setPendingPredictions] = useState([]);
      const [allUsers, setAllUsers] = useState([]);
      const [userBets, setUserBets] = useState([]);
      const [allBets, setAllBets] = useState([]);
      const [profileUser, setProfileUser] = useState(null);
      const [selectedMarket, setSelectedMarket] = useState(null);
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [toasts, setToasts] = useState([]);
      const [loading, setLoading] = useState(true);
      const [initializing, setInitializing] = useState(true);
      const [dataLoaded, setDataLoaded] = useState(false);
      const [activityLog, setActivityLog] = useState([]);
      const [showActivity, setShowActivity] = useState(false);
      const [accessDenied, setAccessDenied] = useState(null); // 'not_in_server' or 'banned'

      const addToast = (msg, type = 'success') => setToasts(prev => [...prev, { id: Date.now(), message: msg, type }]);
      const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));

      const weeklyBetUsed = user?.weekly_bet_used || false;

      // Check for existing session on mount
      useEffect(() => {
        let mounted = true;

        supabase.auth.getSession().then(({ data: { session } }) => {
          if (!mounted) return;
          if (session) {
            // Don't set session here - let handleAuthUser do it after checks
            handleAuthUser(session);
          } else {
            setInitializing(false);
          }
        });

        const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
          if (!mounted) return;
          // Only handle specific events, ignore token refresh and other background events
          if (event === 'SIGNED_IN') {
            // Don't set session until after membership check passes
            if (session) handleAuthUser(session);
          } else if (event === 'SIGNED_OUT') {
            setSession(null);
            setUser(null);
            setInitializing(false);
          }
        });

        return () => {
          mounted = false;
          subscription.unsubscribe();
        };
      }, []);

      const METAVESCO_SERVER_ID = '1413003530931011727';

      const checkMetavescoMembership = async (providerToken) => {
        if (!providerToken) return false; // No token = can't verify = deny
        
        try {
          const guildsResponse = await fetch('https://discord.com/api/users/@me/guilds', {
            headers: { 'Authorization': `Bearer ${providerToken}` }
          });
          
          if (guildsResponse.ok) {
            const guilds = await guildsResponse.json();
            return guilds.some(g => g.id === METAVESCO_SERVER_ID);
          }
          return false; // If API fails, deny
        } catch (err) {
          console.error('Error checking Discord guilds:', err);
          return false; // If error, deny
        }
      };

      const handleAuthUser = async (session) => {
        const authUser = session.user;
        try {
          // Get Discord metadata
          const discordUsername = authUser.user_metadata?.full_name || authUser.user_metadata?.name || authUser.email?.split('@')[0];
          const discordAvatar = authUser.user_metadata?.avatar_url;
          const discordId = authUser.user_metadata?.provider_id;

          // First check if user already exists in our database
          let { data: existingUser, error: fetchError } = await supabase
            .from('users')
            .select('*')
            .eq('discord_id', discordId)
            .single();

          if (fetchError && fetchError.code !== 'PGRST116') {
            // Try by username
            const { data: userByName } = await supabase
              .from('users')
              .select('*')
              .eq('username', discordUsername.toLowerCase())
              .single();
            existingUser = userByName;
          }

          if (existingUser) {
            // EXISTING USER - already verified before
            // Check if user is banned
            if (existingUser.banned) {
              await supabase.auth.signOut();
              setSession(null);
              setUser(null);
              setAccessDenied('banned');
              setInitializing(false);
              return;
            }
            // Set session and user
            setSession(session);
            // Update avatar if changed
            if (existingUser.avatar_url !== discordAvatar) {
              await supabase
                .from('users')
                .update({ avatar_url: discordAvatar })
                .eq('id', existingUser.id);
            }
            setUser({ ...existingUser, avatar_url: discordAvatar, user_metadata: authUser.user_metadata });
          } else {
            // NEW USER - must verify Discord server membership
            // provider_token is required for new users
            if (!session.provider_token) {
              // No token available - force re-auth
              await supabase.auth.signOut();
              setSession(null);
              setUser(null);
              setAccessDenied('not_in_server');
              setInitializing(false);
              return;
            }

            // Check guild membership
            const inMetavesco = await checkMetavescoMembership(session.provider_token);
            
            if (!inMetavesco) {
              await supabase.auth.signOut();
              setSession(null);
              setUser(null);
              setAccessDenied('not_in_server');
              setInitializing(false);
              return;
            }

            // Membership verified - create new user
            setSession(session);
            const { data: newUser, error: insertError } = await supabase
              .from('users')
              .insert([{ 
                username: discordUsername.toLowerCase(),
                discord_id: discordId,
                avatar_url: discordAvatar
              }])
              .select()
              .single();

            if (insertError) throw insertError;

            setUser({ ...newUser, user_metadata: authUser.user_metadata });
          }
        } catch (err) {
          console.error('Error handling auth user:', err);
          addToast('Error setting up profile', 'error');
        } finally {
          setInitializing(false);
        }
      };

      // Load data when user is set - only once
      useEffect(() => {
        if (user && !dataLoaded) {
          loadData();
        }
      }, [user, dataLoaded]);

      // Realtime subscriptions
      useEffect(() => {
        if (!user) return;

        const marketsChannel = supabase
          .channel('markets-changes')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'markets' }, (payload) => {
            console.log('Markets change:', payload);
            if (payload.eventType === 'INSERT') {
              setMarkets(prev => [payload.new, ...prev]);
            } else if (payload.eventType === 'UPDATE') {
              setMarkets(prev => prev.map(m => m.id === payload.new.id ? payload.new : m));
            } else if (payload.eventType === 'DELETE') {
              setMarkets(prev => prev.filter(m => m.id !== payload.old.id));
            }
          })
          .subscribe();

        const activityChannel = supabase
          .channel('activity-changes')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'activity_log' }, (payload) => {
            console.log('Activity change:', payload);
            setActivityLog(prev => [payload.new, ...prev].slice(0, 50));
          })
          .subscribe();

        const betsChannel = supabase
          .channel('bets-changes')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'bets' }, (payload) => {
            console.log('Bets change:', payload);
            // Refresh markets to update volumes/percentages
            supabase.from('markets').select('*').order('created_at', { ascending: false })
              .then(({ data }) => { if (data) setMarkets(data); });
            // Refresh user's bets for portfolio
            supabase.from('bets').select('*').eq('user_id', user.id)
              .then(({ data }) => { if (data) setUserBets(data); });
            // Refresh all bets for admin
            if (user.is_admin) {
              supabase.from('bets').select('*')
                .then(({ data }) => { if (data) setAllBets(data); });
            }
          })
          .subscribe();

        const usersChannel = supabase
          .channel('users-changes')
          .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'users' }, (payload) => {
            console.log('Users change:', payload);
            setLeaderboard(prev => prev.map(u => u.id === payload.new.id ? payload.new : u));
            if (user.is_admin) {
              setAllUsers(prev => prev.map(u => u.id === payload.new.id ? payload.new : u));
            }
          })
          .subscribe();

        // Admin-only: pending predictions
        let pendingChannel = null;
        if (user.is_admin) {
          pendingChannel = supabase
            .channel('pending-changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'pending_predictions' }, (payload) => {
              console.log('Pending change:', payload);
              if (payload.eventType === 'INSERT') {
                setPendingPredictions(prev => [payload.new, ...prev]);
              } else if (payload.eventType === 'DELETE') {
                setPendingPredictions(prev => prev.filter(p => p.id !== payload.old.id));
              } else if (payload.eventType === 'UPDATE') {
                setPendingPredictions(prev => prev.map(p => p.id === payload.new.id ? payload.new : p));
              }
            })
            .subscribe();
        }

        return () => {
          supabase.removeChannel(marketsChannel);
          supabase.removeChannel(activityChannel);
          supabase.removeChannel(betsChannel);
          supabase.removeChannel(usersChannel);
          if (pendingChannel) supabase.removeChannel(pendingChannel);
        };
      }, [user]);

      const loadData = async () => {
        if (dataLoaded) return;
        setLoading(true);
        try {
          // Fetch all markets (active and resolved) for profile history
          const { data: marketsData } = await supabase
            .from('markets')
            .select('*')
            .order('created_at', { ascending: false });
          setMarkets(marketsData || []);

          const { data: leaderboardData } = await supabase
            .from('users')
            .select('*')
            .gt('total_wins', 0)
            .order('total_wins', { ascending: false })
            .limit(100);
          setLeaderboard(leaderboardData || []);

          const { data: betsData } = await supabase
            .from('bets')
            .select('*')
            .eq('user_id', user.id);
          setUserBets(betsData || []);

          // Fetch activity log
          const { data: activityData } = await supabase
            .from('activity_log')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50);
          setActivityLog(activityData || []);

          if (user.is_admin) {
            const { data: pendingData } = await supabase
              .from('pending_predictions')
              .select('*')
              .order('created_at', { ascending: false });
            setPendingPredictions(pendingData || []);

            const { data: usersData } = await supabase
              .from('users')
              .select('*')
              .order('username', { ascending: true });
            setAllUsers(usersData || []);
          }
          setDataLoaded(true);
        } catch (err) {
          console.error('Error loading data:', err);
          addToast('Failed to load data', 'error');
        } finally {
          setLoading(false);
        }
      };

      const refreshData = async () => {
        setLoading(true);
        try {
          const { data: marketsData } = await supabase
            .from('markets')
            .select('*')
            .order('created_at', { ascending: false });
          setMarkets(marketsData || []);

          const { data: leaderboardData } = await supabase
            .from('users')
            .select('*')
            .gt('total_wins', 0)
            .order('total_wins', { ascending: false })
            .limit(100);
          setLeaderboard(leaderboardData || []);

          // Fetch activity log
          const { data: activityData } = await supabase
            .from('activity_log')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50);
          setActivityLog(activityData || []);

          const { data: betsData } = await supabase
            .from('bets')
            .select('*')
            .eq('user_id', user.id);
          setUserBets(betsData || []);

          if (user.is_admin) {
            const { data: pendingData } = await supabase
              .from('pending_predictions')
              .select('*')
              .order('created_at', { ascending: false });
            setPendingPredictions(pendingData || []);

            const { data: usersData } = await supabase
              .from('users')
              .select('*')
              .order('username', { ascending: true });
            setAllUsers(usersData || []);
          }
        } catch (err) {
          console.error('Error loading data:', err);
          addToast('Failed to load data', 'error');
        } finally {
          setLoading(false);
        }
      };

      const handleLogout = async () => {
        await supabase.auth.signOut();
        setUser(null);
        setSession(null);
        setMarkets([]);
        setUserBets([]);
        setAllUsers([]);
        setActivityLog([]);
        setShowActivity(false);
        setDataLoaded(false);
        setActivePage('markets');
      };

      const handleBet = async (marketId, side) => {
        if (weeklyBetUsed) {
          addToast('You already used your weekly bet!', 'error');
          return;
        }

        try {
          const { error: betError } = await supabase
            .from('bets')
            .insert([{ user_id: user.id, market_id: marketId, side }]);

          if (betError) throw betError;

          const { error: userError } = await supabase
            .from('users')
            .update({ weekly_bet_used: true })
            .eq('id', user.id);

          if (userError) throw userError;

          const market = markets.find(m => m.id === marketId);
          const newYes = side === 'yes' ? Math.min(99, market.yes_percent + 1) : Math.max(1, market.yes_percent - 1);
          const newNo = 100 - newYes;

          await supabase
            .from('markets')
            .update({ 
              volume: (market.volume || 0) + 1000,
              yes_percent: newYes,
              no_percent: newNo
            })
            .eq('id', marketId);

          setUser({ ...user, weekly_bet_used: true });
          setUserBets([...userBets, { user_id: user.id, market_id: marketId, side }]);
          setMarkets(markets.map(m => m.id === marketId ? { ...m, volume: (m.volume || 0) + 1000, yes_percent: newYes, no_percent: newNo } : m));
          setSelectedMarket(null);
          addToast(`Bet placed on ${side.toUpperCase()}! Good luck! üéØ`);
        } catch (err) {
          console.error('Error placing bet:', err);
          addToast('Failed to place bet. Please try again.', 'error');
        }
      };

      const handleCreatePrediction = async (data) => {
        try {
          const { data: newPred, error } = await supabase
            .from('pending_predictions')
            .insert([data])
            .select()
            .single();

          if (error) throw error;
          
          // Add to pending predictions list immediately (for admins)
          if (user.is_admin && newPred) {
            setPendingPredictions([newPred, ...pendingPredictions]);
          }

          // Discord notification for admins
          sendDiscordNotification(null, {
            title: 'üìù New Suggestion Submitted',
            description: `**${user.username}** submitted a prediction for review:\n\n${data.ticker ? '$' + data.ticker + ' - ' : ''}${data.title}`,
            color: 0xfbbf24,
            fields: [
              { name: 'Category', value: data.category, inline: true },
              { name: 'Ends', value: formatDate(data.ends_at), inline: true }
            ],
            footer: { text: 'OTCfi Pulse ‚Ä¢ Admin Review Needed' },
            timestamp: new Date().toISOString()
          }, true);
          
          addToast('Prediction submitted for review!');
        } catch (err) {
          console.error('Error submitting prediction:', err);
          addToast('Failed to submit prediction.', 'error');
        }
      };

      const handleApprovePrediction = async (pred) => {
        try {
          const { data: marketData, error: insertError } = await supabase
            .from('markets')
            .insert([{
              title: pred.title,
              category: pred.category,
              ticker: pred.ticker,
              company: pred.company,
              ends_at: pred.ends_at,
              resolution: `This market resolves based on: ${pred.title}`,
              created_by: pred.created_by
            }])
            .select()
            .single();

          if (insertError) throw insertError;

          const { error: deleteError } = await supabase
            .from('pending_predictions')
            .delete()
            .eq('id', pred.id);

          if (deleteError) throw deleteError;

          // Log activity
          const activityMessage = `New market: ${pred.ticker ? '$' + pred.ticker + ' - ' : ''}${pred.title.substring(0, 35)}`;
          await supabase
            .from('activity_log')
            .insert([{ type: 'new_market', market_id: marketData?.id, message: activityMessage }]);
          
          const newActivity = { id: Date.now(), type: 'new_market', message: activityMessage, created_at: new Date().toISOString() };
          setActivityLog([newActivity, ...activityLog]);

          // Discord notification
          sendDiscordNotification(null, {
            title: 'üìã New Market Live',
            description: `**${pred.ticker ? '$' + pred.ticker + ' - ' : ''}${pred.title}**\n\nüìÅ Category: ${pred.category}\nüìÖ Ends: ${formatDate(pred.ends_at)}`,
            color: 0x16d9f1,
            footer: { text: 'OTCfi Pulse' },
            timestamp: new Date().toISOString(),
            url: 'https://pulse.otcfi.io'
          });

          await refreshData();
          addToast('Prediction approved!');
        } catch (err) {
          console.error('Error approving prediction:', err);
          addToast('Failed to approve prediction.', 'error');
        }
      };

      const handleRejectPrediction = async (id) => {
        try {
          const { error } = await supabase
            .from('pending_predictions')
            .delete()
            .eq('id', id);

          if (error) throw error;
          setPendingPredictions(pendingPredictions.filter(p => p.id !== id));
          addToast('Prediction rejected', 'error');
        } catch (err) {
          console.error('Error rejecting prediction:', err);
          addToast('Failed to reject prediction.', 'error');
        }
      };

      const handleResolveMarket = async (id, winner) => {
        try {
          const market = markets.find(m => m.id === id);
          
          const { error } = await supabase
            .from('markets')
            .update({ status: 'resolved', winner, resolved_at: new Date().toISOString() })
            .eq('id', id);

          if (error) throw error;

          // Log activity
          const activityMessage = `${market.ticker ? '$' + market.ticker : market.title.substring(0, 25)} resolved - ${winner.toUpperCase()} wins!`;
          await supabase
            .from('activity_log')
            .insert([{ type: 'resolve', market_id: id, message: activityMessage }]);
          
          const newActivity = { id: Date.now(), type: 'resolve', message: activityMessage, created_at: new Date().toISOString() };
          setActivityLog([newActivity, ...activityLog]);

          // Discord notification
          sendDiscordNotification(null, {
            title: '‚úÖ Market Resolved',
            description: `**${market.ticker ? '$' + market.ticker : market.title}**\n\nüèÜ **${winner.toUpperCase()}** wins!`,
            color: winner === 'yes' ? 0x22c55e : 0xef4444,
            footer: { text: 'OTCfi Pulse' },
            timestamp: new Date().toISOString()
          });

          setMarkets(markets.filter(m => m.id !== id));
          addToast(`Market resolved! ${winner.toUpperCase()} wins!`);
        } catch (err) {
          console.error('Error resolving market:', err);
          addToast('Failed to resolve market.', 'error');
        }
      };

      const handleToggleAdmin = async (userId, makeAdmin) => {
        try {
          const { error } = await supabase
            .from('users')
            .update({ is_admin: makeAdmin })
            .eq('id', userId);

          if (error) throw error;

          setAllUsers(allUsers.map(u => u.id === userId ? { ...u, is_admin: makeAdmin } : u));
          addToast(makeAdmin ? 'User is now an admin!' : 'Admin access removed');
        } catch (err) {
          console.error('Error updating admin status:', err);
          addToast('Failed to update admin status.', 'error');
        }
      };

      const handleDeleteUser = async (userId) => {
        try {
          // Delete user's activity logs first
          await supabase
            .from('activity_log')
            .delete()
            .eq('user_id', userId);

          // Delete user's bets
          await supabase
            .from('bets')
            .delete()
            .eq('user_id', userId);

          // Delete user
          const { error } = await supabase
            .from('users')
            .delete()
            .eq('id', userId);

          if (error) throw error;

          setAllUsers(allUsers.filter(u => u.id !== userId));
          setLeaderboard(leaderboard.filter(u => u.id !== userId));
          addToast('User kicked successfully');
        } catch (err) {
          console.error('Error deleting user:', err);
          addToast('Failed to kick user.', 'error');
        }
      };

      const handleBanUser = async (userId) => {
        try {
          const { error } = await supabase
            .from('users')
            .update({ banned: true })
            .eq('id', userId);

          if (error) throw error;

          setAllUsers(allUsers.map(u => u.id === userId ? { ...u, banned: true } : u));
          addToast('User banned successfully');
        } catch (err) {
          console.error('Error banning user:', err);
          addToast('Failed to ban user.', 'error');
        }
      };

      const handleUnbanUser = async (userId) => {
        try {
          const { error } = await supabase
            .from('users')
            .update({ banned: false })
            .eq('id', userId);

          if (error) throw error;

          setAllUsers(allUsers.map(u => u.id === userId ? { ...u, banned: false } : u));
          addToast('User unbanned successfully');
        } catch (err) {
          console.error('Error unbanning user:', err);
          addToast('Failed to unban user.', 'error');
        }
      };

      const handleEditMarket = async (marketId, updates) => {
        try {
          const { error } = await supabase
            .from('markets')
            .update({
              title: updates.title,
              ticker: updates.ticker,
              company: updates.company,
              ends_at: updates.ends_at
            })
            .eq('id', marketId);

          if (error) throw error;

          setMarkets(markets.map(m => m.id === marketId ? { ...m, ...updates } : m));
          addToast('Market updated successfully');
        } catch (err) {
          console.error('Error updating market:', err);
          addToast('Failed to update market.', 'error');
        }
      };

      const handleEditPending = async (predId, updates) => {
        try {
          const { error } = await supabase
            .from('pending_predictions')
            .update({
              title: updates.title,
              ticker: updates.ticker,
              company: updates.company,
              category: updates.category,
              ends_at: updates.ends_at
            })
            .eq('id', predId);

          if (error) throw error;

          setPendingPredictions(pendingPredictions.map(p => p.id === predId ? { ...p, ...updates } : p));
          addToast('Prediction updated successfully');
        } catch (err) {
          console.error('Error updating prediction:', err);
          addToast('Failed to update prediction.', 'error');
        }
      };

      const handleClearActivity = async () => {
        try {
          const { error } = await supabase.rpc('clear_activity_log');
          
          if (error) throw error;
          setActivityLog([]);
          addToast('Activity feed cleared');
        } catch (err) {
          console.error('Error clearing activity:', err);
          addToast('Failed to clear activity feed.', 'error');
        }
      };

      const handleClearHistory = async () => {
        try {
          const { error } = await supabase.rpc('clear_resolved_markets');
          
          if (error) throw error;
          setMarkets(markets.filter(m => m.status !== 'resolved'));
          addToast('Market history cleared');
        } catch (err) {
          console.error('Error clearing history:', err);
          addToast('Failed to clear history.', 'error');
        }
      };

      const handleViewProfile = async (userId) => {
        try {
          setLoading(true);
          
          // If viewing own profile, use current user data
          if (userId === user.id) {
            setProfileUser(user);
          } else {
            // Fetch the user's profile
            const { data: profileData, error } = await supabase
              .from('users')
              .select('*')
              .eq('id', userId)
              .single();
            
            if (error) throw error;
            setProfileUser(profileData);
          }
          
          // Fetch user's bets for history
          const { data: betsData } = await supabase
            .from('bets')
            .select('*')
            .eq('user_id', userId);
          setAllBets(betsData || []);
          
          setActivePage('profile');
        } catch (err) {
          console.error('Error loading profile:', err);
          addToast('Failed to load profile', 'error');
        } finally {
          setLoading(false);
        }
      };

      const handleUpdateProfile = async (updates) => {
        try {
          const { error } = await supabase
            .from('users')
            .update(updates)
            .eq('id', user.id);

          if (error) throw error;

          // Update local user state
          setUser({ ...user, ...updates });
          setProfileUser({ ...profileUser, ...updates });
          addToast('Profile updated!');
        } catch (err) {
          console.error('Error updating profile:', err);
          addToast('Failed to update profile', 'error');
        }
      };

      // Show loading while checking auth
      if (initializing) {
        return (
          <div className="login-container">
            <div className="loading">
              <div className="loading-spinner">‚ü≥</div>
              <p>Loading...</p>
            </div>
          </div>
        );
      }

      // Show access denied page
      if (accessDenied) {
        return (
          <div className="login-container">
            <div className="login-card" style={{ textAlign: 'center' }}>
              <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>
                {accessDenied === 'banned' ? 'üö´' : 'üîí'}
              </div>
              <h1 style={{ color: 'var(--text-primary)', marginBottom: '0.5rem' }}>
                {accessDenied === 'banned' ? 'Account Banned' : 'Access Denied'}
              </h1>
              <p style={{ color: 'var(--text-muted)', marginBottom: '1.5rem' }}>
                {accessDenied === 'banned' 
                  ? 'Your account has been banned from OTCfi Pulse.' 
                  : 'You must be a member of the Metavesco Discord server to access OTCfi Pulse.'}
              </p>
              {accessDenied === 'not_in_server' && (
                <>
                  <a 
                    href="https://discord.gg/nA5sx6PrwX" 
                    target="_blank" 
                    rel="noopener noreferrer"
                    className="btn btn-primary"
                    style={{ marginBottom: '1rem', display: 'inline-block' }}
                  >
                    Join Metavesco Discord
                  </a>
                  <p style={{ color: 'var(--text-muted)', fontSize: '0.85rem', marginBottom: '1rem' }}>
                    After joining, click the button below to verify.
                  </p>
                </>
              )}
              <button 
                className="btn btn-secondary" 
                onClick={async () => { 
                  setAccessDenied(null);
                  // Go directly to Discord login for fresh token
                  await supabase.auth.signInWithOAuth({
                    provider: 'discord',
                    options: {
                      redirectTo: window.location.origin,
                      scopes: 'identify email guilds'
                    }
                  });
                }}
                style={{ marginTop: '0.5rem' }}
              >
                {accessDenied === 'not_in_server' ? 'I\'ve Joined - Verify Now' : 'Try Again'}
              </button>
            </div>
          </div>
        );
      }

      // Show login if no user
      if (!user) {
        return (
          <>
            <Login />
            <div className="toast-container">{toasts.map(toast => <Toast key={toast.id} message={toast.message} type={toast.type} onClose={() => removeToast(toast.id)} />)}</div>
          </>
        );
      }

      const currentUserBet = selectedMarket ? userBets.find(b => b.market_id === selectedMarket.id) : null;

      return (
        <AppContext.Provider value={{ weeklyBetUsed, userBets }}>
          <Header user={user} activePage={activePage} setActivePage={setActivePage} onLogout={handleLogout} onViewProfile={handleViewProfile} />
          {activePage === 'markets' && <MarketsPage markets={markets} onMarketClick={setSelectedMarket} onCreateClick={() => setShowCreateModal(true)} weeklyBetUsed={weeklyBetUsed} loading={loading} activityLog={activityLog} showActivity={showActivity} onToggleActivity={() => setShowActivity(!showActivity)} isAdmin={user.is_admin} onClearActivity={handleClearActivity} />}
          {activePage === 'history' && <HistoryPage markets={markets} loading={loading} isAdmin={user.is_admin} onClearHistory={handleClearHistory} />}
          {activePage === 'portfolio' && <PortfolioPage userBets={userBets} markets={markets} />}
          {activePage === 'leaderboard' && <LeaderboardPage leaderboard={leaderboard} onViewProfile={handleViewProfile} loading={loading} />}
          {activePage === 'profile' && <ProfilePage profileUser={profileUser} currentUser={user} userBets={allBets} markets={markets} onUpdateProfile={handleUpdateProfile} onViewProfile={handleViewProfile} pendingPredictions={pendingPredictions} loading={loading} />}
          {activePage === 'admin' && user.is_admin && <AdminPage pendingPredictions={pendingPredictions} onApprove={handleApprovePrediction} onReject={handleRejectPrediction} onEditPending={handleEditPending} markets={markets} onResolve={handleResolveMarket} onEditMarket={handleEditMarket} allUsers={allUsers} onToggleAdmin={handleToggleAdmin} onBanUser={handleBanUser} onUnbanUser={handleUnbanUser} onViewProfile={handleViewProfile} allBets={allBets} loading={loading} />}
          {selectedMarket && <MarketDetail market={selectedMarket} onClose={() => setSelectedMarket(null)} onBet={handleBet} weeklyBetUsed={weeklyBetUsed} userBet={currentUserBet} />}
          {showCreateModal && <CreateModal onClose={() => setShowCreateModal(false)} onSubmit={handleCreatePrediction} user={user} />}
          <div className="toast-container">{toasts.map(toast => <Toast key={toast.id} message={toast.message} type={toast.type} onClose={() => removeToast(toast.id)} />)}</div>
        </AppContext.Provider>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
