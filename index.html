<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTCfi Pulse Beta</title>
  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAABAGlDQ1BpY2MAABiVY2BgPMEABCwGDAy5eSVFQe5OChGRUQrsDxgYgRAMEpOLCxhwA6Cqb9cgai/r4lGHC3CmpBYnA+kPQKxSBLQcaKQIkC2SDmFrgNhJELYNiF1eUlACZAeA2EUhQc5AdgqQrZGOxE5CYicXFIHU9wDZNrk5pckIdzPwpOaFBgNpDiCWYShmCGJwZ3AC+R+iJH8RA4PFVwYG5gkIsaSZDAzbWxkYJG4hxFQWMDDwtzAwbDuPEEOESUFiUSJYiAWImdLSGBg+LWdg4I1kYBC+wMDAFQ0LCBxuUwC7zZ0hHwjTGXIYUoEingx5DMkMekCWEYMBgyGDGQCm1j8/yRb+6wAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAA9lBMVEUFARgGAhkGARkJARkJAhkJAhoIARkHARkEARcAABMAABIBABYCARcUAx1fCDZeCDZkCDhhCDdVCDMfAyAAABQIAhkAARUwBSf9FGz+E2zcEWHuEmf8E2vpEmUEARgvBSbzE2j/FHBcCDOuDlD/FG/9E2zgEmIRAhwGARgAARYnBCPAD1erDlBgCTViCjaGC0PLD1osBSYAABUHAhkcAyCXDUpTCDJxCztoCjp5Cj+fDUzfEmIwBSb/FW7sEmb8FG79FXJlCTctBSXvE2eKDEV3Cj8xBScHARgrBCX1FGnGEFkuBCb/FW/VEV4QAhxQBzFCBiwFARcJm6iHAAAAB3RJTUUH6gEbEhoYfZB++QAAAL5JREFUGNNdj+cOwjAMhE0LTRvKDhvC3jvsvSkb8v4vQyhUSPiHZX+S784AomzwV5Jslx0K+gFV0zDWnBaRdJfb4/X5A0T6gGAoHInG4omknyD6BiiUSmeyuXyhWNLLJqhUa/VGs9VOdpgp0630+oPhaDyZupymCiKz+aK4XOXX5OPTZZvtdNfaH4SLEKVgsOPpjDFmVg7ELtebrMjfnUJZvz+eVmj6vgKqkd8fZjbFAODAuSq6mFTxHheTABxe7WcUi0xy1NoAAAAedEVYdGljYzpjb3B5cmlnaHQAR29vZ2xlIEluYy4gMjAxNqwLMzgAAAAUdEVYdGljYzpkZXNjcmlwdGlvbgBzUkdCupBzBwAAAABJRU5ErkJggg==">
  <link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAABAGlDQ1BpY2MAABiVY2BgPMEABCwGDAy5eSVFQe5OChGRUQrsDxgYgRAMEpOLCxhwA6Cqb9cgai/r4lGHC3CmpBYnA+kPQKxSBLQcaKQIkC2SDmFrgNhJELYNiF1eUlACZAeA2EUhQc5AdgqQrZGOxE5CYicXFIHU9wDZNrk5pckIdzPwpOaFBgNpDiCWYShmCGJwZ3AC+R+iJH8RA4PFVwYG5gkIsaSZDAzbWxkYJG4hxFQWMDDwtzAwbDuPEEOESUFiUSJYiAWImdLSGBg+LWdg4I1kYBC+wMDAFQ0LCBxuUwC7zZ0hHwjTGXIYUoEingx5DMkMekCWEYMBgyGDGQCm1j8/yRb+6wAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAA9lBMVEUFARgGAhkGARkJARkJAhkJAhoIARkHARkEARcAABMAABIBABYCARcUAx1fCDZeCDZkCDhhCDdVCDMfAyAAABQIAhkAARUwBSf9FGz+E2zcEWHuEmf8E2vpEmUEARgvBSbzE2j/FHBcCDOuDlD/FG/9E2zgEmIRAhwGARgAARYnBCPAD1erDlBgCTViCjaGC0PLD1osBSYAABUHAhkcAyCXDUpTCDJxCztoCjp5Cj+fDUzfEmIwBSb/FW7sEmb8FG79FXJlCTctBSXvE2eKDEV3Cj8xBScHARgrBCX1FGnGEFkuBCb/FW/VEV4QAhxQBzFCBiwFARcJm6iHAAAAB3RJTUUH6gEbEhoYfZB++QAAAL5JREFUGNNdj+cOwjAMhE0LTRvKDhvC3jvsvSkb8v4vQyhUSPiHZX+S784AomzwV5Jslx0K+gFV0zDWnBaRdJfb4/X5A0T6gGAoHInG4omknyD6BiiUSmeyuXyhWNLLJqhUa/VGs9VOdpgp0630+oPhaDyZupymCiKz+aK4XOXX5OPTZZvtdNfaH4SLEKVgsOPpjDFmVg7ELtebrMjfnUJZvz+eVmj6vgKqkd8fZjbFAODAuSq6mFTxHheTABxe7WcUi0xy1NoAAAAedEVYdGljYzpjb3B5cmlnaHQAR29vZ2xlIEluYy4gMjAxNqwLMzgAAAAUdEVYdGljYzpkZXNjcmlwdGlvbgBzUkdCupBzBwAAAABJRU5ErkJggg==">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg-primary: #0a0a12;
      --bg-secondary: #0f0f1a;
      --bg-card: #151520;
      --bg-card-hover: #1a1a28;
      --bg-input: #1a1a28;
      --accent-purple: #a855f7;
      --accent-purple-dim: #7c3aed;
      --accent-magenta: #c026d3;
      --accent-cyan: #16d9f1;
      --accent-green: #22c55e;
      --accent-red: #ef4444;
      --accent-discord: #5865F2;
      --text-primary: #ffffff;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --border-color: #252532;
      --border-light: #2a2a3a;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-primary);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo { display: flex; align-items: baseline; font-size: 1.5rem; font-weight: 700; }
    .logo-otc { color: var(--text-primary); }
    .logo-fi { color: var(--accent-cyan); }
    .logo-pulse { font-size: 0.7rem; color: #fb3393; margin-left: 2px; font-weight: 600; }
    .nav { display: flex; gap: 2rem; }
    .nav-link {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.2s;
      background: none;
      border: none;
      font-family: inherit;
    }
    .nav-link:hover, .nav-link.active { color: var(--text-primary); }
    .header-right { display: flex; align-items: center; gap: 1rem; }
    .balance-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.6rem 1rem;
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.9rem;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .user-btn {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
    }
    .user-btn:hover { border-color: var(--accent-purple); color: var(--text-primary); }
    .main { max-width: 1300px; margin: 0 auto; padding: 2rem; }
    .page-title { font-size: 2rem; font-weight: 600; margin-bottom: 0.5rem; }
    .page-subtitle { color: var(--text-secondary); font-size: 1rem; margin-bottom: 2rem; }
    .stats-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; gap: 2rem; }
    .stat-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .stat-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 1.75rem; font-weight: 600; }
    .category-filters { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .category-pill {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-secondary);
      font-family: inherit;
      transition: all 0.2s;
    }
    .category-pill:hover { border-color: var(--text-muted); color: var(--text-primary); }
    .category-pill.active { background: var(--accent-purple); border-color: var(--accent-purple); color: white; }
    .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 1rem; }
    .market-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .market-card:hover { border-color: var(--border-light); background: var(--bg-card-hover); }
    .market-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
    .market-ticker-row { display: flex; align-items: center; gap: 0.75rem; }
    .ticker-badge {
      background: var(--bg-input);
      border: 1px solid var(--border-light);
      border-radius: 6px;
      padding: 0.3rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .category-badge {
      background: rgba(168, 85, 247, 0.15);
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-radius: 6px;
      padding: 0.3rem 0.5rem;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--accent-purple);
      text-transform: uppercase;
    }
    .market-company { font-size: 0.85rem; color: var(--text-secondary); }
    .market-date { font-size: 0.8rem; color: var(--text-muted); }
    .market-title { font-size: 1rem; font-weight: 500; margin-bottom: 0.75rem; line-height: 1.4; }
    .market-footer { display: flex; justify-content: space-between; align-items: center; }
    .market-meta { display: flex; gap: 1rem; font-size: 0.8rem; color: var(--text-muted); }
    .market-odds { display: flex; gap: 0.5rem; }
    .odds-pill { padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
    .odds-yes { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); border: 1px solid rgba(34, 197, 94, 0.3); }
    .odds-no { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); border: 1px solid rgba(239, 68, 68, 0.3); }
    .bet-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.75rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .bet-available { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); border: 1px solid rgba(34, 197, 94, 0.3); }
    .bet-used { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); border: 1px solid rgba(239, 68, 68, 0.3); }
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 2rem;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content {
      background: var(--bg-primary);
      border-radius: 16px;
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 1rem;
      cursor: pointer;
      background: none;
      border: none;
      font-family: inherit;
    }
    .back-link:hover { color: var(--text-primary); }
    .detail-header { display: flex; align-items: flex-start; gap: 1rem; }
    .detail-ticker {
      width: 50px;
      height: 50px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      color: var(--accent-purple);
    }
    .detail-info h2 { font-size: 0.9rem; color: var(--text-muted); font-weight: 400; margin-bottom: 0.25rem; }
    .detail-info h1 { font-size: 1.25rem; font-weight: 600; }
    .detail-tags { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
    .detail-tag {
      padding: 0.4rem 0.75rem;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    .detail-body { padding: 1.5rem; }
    .resolution-text { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1.5rem; }
    .market-odds-section {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .market-odds-title { font-weight: 600; margin-bottom: 1rem; }
    .odds-display { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .odds-box { background: var(--bg-input); border-radius: 8px; padding: 1rem; }
    .odds-box-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; }
    .odds-box-value { font-size: 1.5rem; font-weight: 600; }
    .odds-box-value.yes { color: var(--accent-green); }
    .odds-box-value.no { color: var(--accent-red); }
    .wager-section {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(192, 38, 211, 0.1));
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-radius: 12px;
      padding: 1.5rem;
    }
    .wager-title { font-weight: 600; margin-bottom: 0.5rem; }
    .wager-balance { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem; }
    .bet-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem; }
    .bet-btn {
      padding: 0.9rem;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .bet-btn-yes { background: var(--accent-purple); border: none; color: white; }
    .bet-btn-yes:hover:not(:disabled) { background: var(--accent-purple-dim); }
    .bet-btn-no { background: transparent; border: 1px solid var(--border-light); color: var(--text-primary); }
    .bet-btn-no:hover:not(:disabled) { background: var(--bg-card); }
    .bet-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .bet-btn.selected { box-shadow: 0 0 0 2px var(--accent-purple); }
    .wager-info { background: var(--bg-input); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .wager-info-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 0.5rem; }
    .wager-info-row:last-child { margin-bottom: 0; }
    .wager-info-label { color: var(--text-muted); }
    .wager-info-value { font-weight: 500; }
    .wager-info-value.yes { color: var(--accent-green); }
    .wager-info-value.no { color: var(--accent-red); }
    .place-wager-btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-magenta));
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .place-wager-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4); }
    .place-wager-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .demo-notice { text-align: center; font-size: 0.8rem; color: var(--text-muted); margin-top: 1rem; }
    .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; }
    .login-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 2.5rem;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .login-subtitle { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 2rem; }
    .discord-btn {
      width: 100%;
      padding: 1rem;
      background: var(--accent-discord);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }
    .discord-btn:hover { background: #4752c4; transform: translateY(-1px); box-shadow: 0 4px 20px rgba(88, 101, 242, 0.4); }
    .discord-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .discord-btn svg { width: 24px; height: 24px; }
    .login-btn, .btn-primary {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-magenta));
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .login-btn:hover, .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4); }
    .login-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .form-group { margin-bottom: 1.25rem; text-align: left; }
    .form-label { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.85rem 1rem;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-purple); }
    .form-input::placeholder { color: var(--text-muted); }
    .form-textarea { min-height: 100px; resize: vertical; }
    .leaderboard {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
    }
    .leaderboard-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .leaderboard-row {
      display: flex;
      align-items: center;
      padding: 0.9rem 1.25rem;
      border-bottom: 1px solid var(--border-color);
      transition: background 0.2s;
    }
    .leaderboard-row:last-child { border-bottom: none; }
    .leaderboard-row:hover { background: var(--bg-card-hover); }
    .leaderboard-rank { width: 32px; font-weight: 700; color: var(--text-muted); }
    .leaderboard-rank.gold { color: #fbbf24; }
    .leaderboard-rank.silver { color: #9ca3af; }
    .leaderboard-rank.bronze { color: #d97706; }
    .leaderboard-user { flex: 1; display: flex; align-items: center; gap: 0.75rem; }
    .leaderboard-avatar {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.75rem;
      color: white;
      overflow: hidden;
    }
    .leaderboard-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .leaderboard-name { font-weight: 500; }
    .leaderboard-stats { display: flex; gap: 2rem; font-size: 0.9rem; }
    .leaderboard-wins { color: var(--accent-green); }
    .leaderboard-earnings { color: var(--accent-purple); }
    .admin-section {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .admin-section-title { font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .pending-item {
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }
    .pending-item:last-child { margin-bottom: 0; }
    .pending-info { flex: 1; }
    .pending-title { font-weight: 500; margin-bottom: 0.25rem; }
    .pending-meta { font-size: 0.8rem; color: var(--text-muted); }
    .pending-actions { display: flex; gap: 0.5rem; }
    .btn-sm {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .btn-approve { background: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.3); color: var(--accent-green); }
    .btn-approve:hover { background: var(--accent-green); color: white; }
    .btn-reject { background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); color: var(--accent-red); }
    .btn-reject:hover { background: var(--accent-red); color: white; }
    .create-modal {
      background: var(--bg-card);
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .create-modal-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .create-modal-title { font-size: 1.1rem; font-weight: 600; }
    .close-btn { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; line-height: 1; }
    .close-btn:hover { color: var(--text-primary); }
    .create-modal-body { padding: 1.5rem; }
    .create-modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }
    .btn {
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .btn-secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
    .btn-secondary:hover { background: var(--bg-card-hover); border-color: var(--text-muted); }
    .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.5rem; }
    .toast {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .toast-success { border-color: var(--accent-green); }
    .toast-error { border-color: var(--accent-red); }
    .toast-icon { font-size: 1.1rem; }
    .toast-success .toast-icon { color: var(--accent-green); }
    .toast-error .toast-icon { color: var(--accent-red); }
    .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-muted); }
    .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    .empty-state-title { font-size: 1.1rem; font-weight: 500; color: var(--text-primary); margin-bottom: 0.5rem; }
    .suggest-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1rem;
      background: var(--accent-purple);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .suggest-btn:hover { background: var(--accent-purple-dim); }
    .already-bet-notice {
      text-align: center;
      padding: 1rem;
      background: var(--bg-input);
      border-radius: 8px;
      color: var(--text-secondary);
    }
    .already-bet-notice strong { color: var(--accent-green); }
    .category-select-group { display: flex; gap: 0.5rem; margin-bottom: 1.25rem; }
    .category-select-btn {
      flex: 1;
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }
    .category-select-btn:hover { border-color: var(--text-muted); color: var(--text-primary); }
    .category-select-btn.active { background: var(--accent-purple); border-color: var(--accent-purple); color: white; }
    .confirm-modal {
      background: var(--bg-card);
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      padding: 2rem;
      text-align: center;
    }
    .confirm-icon { font-size: 3rem; margin-bottom: 1rem; }
    .confirm-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
    .confirm-message { color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem; }
    .confirm-details { background: var(--bg-input); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; text-align: left; }
    .confirm-detail-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .confirm-detail-row:last-child { margin-bottom: 0; }
    .confirm-detail-label { color: var(--text-muted); }
    .confirm-detail-value { font-weight: 500; }
    .confirm-detail-value.yes { color: var(--accent-green); }
    .confirm-detail-value.no { color: var(--accent-red); }
    .confirm-buttons { display: flex; gap: 0.75rem; }
    .confirm-buttons .btn { flex: 1; }
    .confirm-warning { color: var(--accent-red); font-size: 0.85rem; margin-top: 1rem; }
    .loading { text-align: center; padding: 4rem; color: var(--text-muted); }
    .loading-spinner { font-size: 2rem; animation: spin 1s linear infinite; display: inline-block; margin-bottom: 1rem; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    /* Profile Page Styles */
    .profile-header { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem; }
    .profile-avatar-large {
      width: 100px;
      height: 100px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 2rem;
      color: white;
      overflow: hidden;
      flex-shrink: 0;
    }
    .profile-avatar-large img { width: 100%; height: 100%; object-fit: cover; }
    .profile-info { flex: 1; }
    .profile-username { font-size: 1.75rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.25rem; }
    .admin-badge { background: var(--accent-purple); color: white; font-size: 0.7rem; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; }
    .profile-joined { color: var(--text-muted); font-size: 0.9rem; }
    .profile-private-notice { color: var(--text-muted); font-size: 0.95rem; margin-top: 0.5rem; }
    .profile-section { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .profile-section-title { font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
    .stat-card { background: var(--bg-input); border-radius: 8px; padding: 1rem; text-align: center; }
    .stat-card-value { font-size: 1.5rem; font-weight: 700; color: var(--accent-purple); margin-bottom: 0.25rem; }
    .stat-card-label { font-size: 0.8rem; color: var(--text-muted); }
    .privacy-toggle { margin-bottom: 1rem; }
    .toggle-label { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
    .toggle-label input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent-purple); cursor: pointer; }
    .toggle-text { font-weight: 500; }
    .toggle-description { color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem; margin-left: 1.75rem; }
    .history-filters { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .history-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .history-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-input); border-radius: 8px; padding: 1rem; }
    .history-info { flex: 1; }
    .history-market { font-weight: 500; margin-bottom: 0.25rem; }
    .history-meta { font-size: 0.85rem; color: var(--text-muted); }
    .text-green { color: var(--accent-green); }
    .text-red { color: var(--accent-red); }
    .history-result { font-weight: 600; font-size: 0.85rem; padding: 0.4rem 0.75rem; border-radius: 6px; }
    .history-result.won { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
    .history-result.lost { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
    .history-result.pending { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }
    .profile-link:hover { border-color: var(--accent-purple); }
    
    @media (max-width: 768px) {
      .header { padding: 1rem; flex-wrap: wrap; gap: 1rem; }
      .nav { order: 3; width: 100%; justify-content: center; gap: 1.5rem; }
      .main { padding: 1rem; }
      .market-grid { grid-template-columns: 1fr; }
      .stats-row { flex-direction: column; }
      .profile-header { flex-direction: column; text-align: center; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect, createContext, useContext } = React;

    // Supabase Configuration
    const SUPABASE_URL = 'https://dopwnybfryhmxrrxrkdn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRvcHdueWJmcnlobXhycnhya2RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjk5NjUsImV4cCI6MjA4NDYwNTk2NX0.J2h-7jK6B5yjI5_m90_guM-Q8RzufpLPu2Td19ILfco';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const AppContext = createContext();
    const categories = ["All", "Price", "Events", "Other"];

    const getTodayDate = () => {
      const today = new Date();
      today.setDate(today.getDate() + 1);
      return today.toISOString().split('T')[0];
    };

    const formatDate = (dateStr) => {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' });
    };

    function Toast({ message, type, onClose }) {
      useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
      return (<div className={`toast toast-${type}`}><span className="toast-icon">{type === 'success' ? '‚úì' : '‚úó'}</span><span>{message}</span></div>);
    }

    function ConfirmModal({ title, message, details, onConfirm, onCancel, confirmText = "Confirm", cancelText = "Cancel", icon = "‚ö†Ô∏è", warning }) {
      return (
        <div className="modal-overlay" onClick={onCancel}>
          <div className="confirm-modal" onClick={e => e.stopPropagation()}>
            <div className="confirm-icon">{icon}</div>
            <h2 className="confirm-title">{title}</h2>
            <p className="confirm-message">{message}</p>
            {details && (
              <div className="confirm-details">
                {details.map((detail, i) => (
                  <div key={i} className="confirm-detail-row">
                    <span className="confirm-detail-label">{detail.label}</span>
                    <span className={`confirm-detail-value ${detail.className || ''}`}>{detail.value}</span>
                  </div>
                ))}
              </div>
            )}
            <div className="confirm-buttons">
              <button className="btn btn-secondary" onClick={onCancel}>{cancelText}</button>
              <button className="btn btn-primary" style={{width: 'auto'}} onClick={onConfirm}>{confirmText}</button>
            </div>
            {warning && <p className="confirm-warning">{warning}</p>}
          </div>
        </div>
      );
    }

    function DiscordIcon() {
      return (
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
        </svg>
      );
    }

    function Login({ onLoginSuccess }) {
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleDiscordLogin = async () => {
        setLoading(true);
        setError('');

        try {
          const { error } = await supabase.auth.signInWithOAuth({
            provider: 'discord',
            options: {
              redirectTo: window.location.origin
            }
          });

          if (error) throw error;
        } catch (err) {
          console.error('Discord login error:', err);
          setError('Failed to login with Discord. Please try again.');
          setLoading(false);
        }
      };

      return (
        <div className="login-container">
          <div className="login-card">
            <div className="logo" style={{ justifyContent: 'center', marginBottom: '1.5rem', fontSize: '2rem' }}>
              <span className="logo-otc">OTC</span><span className="logo-fi">fi</span><span className="logo-pulse">Pulse</span>
            </div>
            <p className="login-subtitle">Predict OTC stock outcomes and win OTCfi tokens. Connect with Discord to get started.</p>
            {error && <p style={{ color: 'var(--accent-red)', marginBottom: '1rem', fontSize: '0.9rem' }}>{error}</p>}
            <button className="discord-btn" onClick={handleDiscordLogin} disabled={loading}>
              <DiscordIcon />
              {loading ? 'Connecting...' : 'Continue with Discord'}
            </button>
          </div>
        </div>
      );
    }

    function Header({ user, activePage, setActivePage, onLogout, onViewProfile }) {
      const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
      const avatarUrl = user.avatar_url || user.user_metadata?.avatar_url;
      const username = user.username || user.user_metadata?.full_name || user.user_metadata?.name || 'User';

      return (
        <>
          <header className="header">
            <div className="logo"><span className="logo-otc">OTC</span><span className="logo-fi">fi</span><span className="logo-pulse">Pulse</span></div>
            <nav className="nav">
              <button className={`nav-link ${activePage === 'markets' ? 'active' : ''}`} onClick={() => setActivePage('markets')}>Markets</button>
              <button className={`nav-link ${activePage === 'portfolio' ? 'active' : ''}`} onClick={() => setActivePage('portfolio')}>Portfolio</button>
              <button className={`nav-link ${activePage === 'leaderboard' ? 'active' : ''}`} onClick={() => setActivePage('leaderboard')}>Leaderboard</button>
              {user.is_admin && <button className={`nav-link ${activePage === 'admin' ? 'active' : ''}`} onClick={() => setActivePage('admin')}>Admin</button>}
            </nav>
            <div className="header-right">
              <div className="balance-btn profile-link" onClick={() => onViewProfile(user.id)} style={{ cursor: 'pointer' }}>
                <span>üë§</span>
                <span>{username}</span>
              </div>
              <div className="user-avatar profile-link" onClick={() => onViewProfile(user.id)} style={{ cursor: 'pointer' }}>
                {avatarUrl ? <img src={avatarUrl} alt="Avatar" /> : 'üë§'}
              </div>
              <button className="user-btn" onClick={() => setShowLogoutConfirm(true)} title="Logout">‚ùå</button>
            </div>
          </header>
          
          {showLogoutConfirm && (
            <ConfirmModal
              icon="‚ùå"
              title="Log Out?"
              message="Are you sure you want to log out of OTCfi Pulse?"
              confirmText="Log Out"
              cancelText="Stay"
              onConfirm={onLogout}
              onCancel={() => setShowLogoutConfirm(false)}
            />
          )}
        </>
      );
    }

    function MarketCard({ market, onClick }) {
      return (
        <div className="market-card" onClick={() => onClick(market)}>
          <div className="market-header">
            <div className="market-ticker-row">
              {market.ticker && <span className="ticker-badge">{market.ticker}</span>}
              {market.company && <span className="market-company">{market.company}</span>}
              <span className="category-badge">{market.category}</span>
            </div>
            <span className="market-date">Ends {formatDate(market.ends_at)}</span>
          </div>
          <h3 className="market-title">{market.title}</h3>
          <div className="market-footer">
            <div className="market-meta"><span>Vol: {market.volume?.toLocaleString() || 0}</span></div>
            <div className="market-odds"><span className="odds-pill odds-yes">Yes {market.yes_percent}%</span><span className="odds-pill odds-no">No {market.no_percent}%</span></div>
          </div>
        </div>
      );
    }

    function MarketDetail({ market, onClose, onBet, weeklyBetUsed, userBet }) {
      const [selectedSide, setSelectedSide] = useState('yes');
      const [showConfirm, setShowConfirm] = useState(false);
      const isPriceMarket = market.category === 'Price';

      const handleConfirmWager = () => {
        onBet(market.id, selectedSide);
        setShowConfirm(false);
      };

      return (
        <>
          <div className="modal-overlay" onClick={onClose}>
            <div className="modal-content" onClick={e => e.stopPropagation()}>
              <div className="modal-header">
                <button className="back-link" onClick={onClose}>‚Üê Back to markets</button>
                <div className="detail-header">
                  <div className="detail-ticker">{market.ticker || market.category.charAt(0)}</div>
                  <div className="detail-info">
                    <h2>{market.company || market.category}</h2>
                    <h1>{market.title}</h1>
                  </div>
                </div>
                <div className="detail-tags">
                  {market.ticker && <span className="detail-tag">Ticker: {market.ticker}</span>}
                  {market.company && <span className="detail-tag">Company: {market.company}</span>}
                  <span className="detail-tag">Category: {market.category}</span>
                  <span className="detail-tag">Ends: {formatDate(market.ends_at)}</span>
                  <span className="detail-tag">Volume: {market.volume?.toLocaleString() || 0}</span>
                </div>
              </div>
              <div className="detail-body">
                <p className="resolution-text">{market.resolution}</p>
                <div className="market-odds-section">
                  <h3 className="market-odds-title">Market Odds</h3>
                  <div className="odds-display">
                    <div className="odds-box"><div className="odds-box-label">Yes</div><div className="odds-box-value yes">{market.yes_percent}%</div></div>
                    <div className="odds-box"><div className="odds-box-label">No</div><div className="odds-box-value no">{market.no_percent}%</div></div>
                  </div>
                </div>
                <div className="wager-section">
                  <h3 className="wager-title">Place Wager</h3>
                  <p className="wager-balance">{weeklyBetUsed ? <span className="bet-status-badge bet-used">Weekly bet used</span> : <span className="bet-status-badge bet-available">1 free bet available this week</span>}</p>
                  {userBet ? (
                    <div className="already-bet-notice">You already bet <strong>{userBet.side.toUpperCase()}</strong> on this market. Good luck! üéØ</div>
                  ) : (
                    <>
                      <div className="bet-buttons">
                        <button className={`bet-btn bet-btn-yes ${selectedSide === 'yes' ? 'selected' : ''}`} onClick={() => setSelectedSide('yes')} disabled={weeklyBetUsed}>Bet YES</button>
                        <button className={`bet-btn bet-btn-no ${selectedSide === 'no' ? 'selected' : ''}`} onClick={() => setSelectedSide('no')} disabled={weeklyBetUsed}>Bet NO</button>
                      </div>
                      <div className="wager-info">
                        <div className="wager-info-row"><span className="wager-info-label">Selected side</span><span className={`wager-info-value ${selectedSide}`}>{selectedSide.toUpperCase()}</span></div>
                        <div className="wager-info-row"><span className="wager-info-label">Potential reward</span><span className="wager-info-value">1,000 OTCfi</span></div>
                      </div>
                      <button className="place-wager-btn" onClick={() => setShowConfirm(true)} disabled={weeklyBetUsed}>Place Wager</button>
                    </>
                  )}
                  <p className="demo-notice">This is a demo interface for OTCfi Pulse. Wagers are simulated credits only.</p>
                </div>
              </div>
            </div>
          </div>

          {showConfirm && (
            <ConfirmModal
              icon="üéØ"
              title="Confirm Your Wager"
              message="Are you sure you want to place this bet? This will use your weekly wager."
              details={[
                { label: "Market", value: market.title.length > 40 ? market.title.substring(0, 40) + '...' : market.title },
                { label: "Your Pick", value: selectedSide.toUpperCase(), className: selectedSide },
                { label: "Potential Reward", value: "1,000 OTCfi" }
              ]}
              warning="‚ö†Ô∏è You can only place 1 bet per week"
              confirmText="Place Wager"
              onConfirm={handleConfirmWager}
              onCancel={() => setShowConfirm(false)}
            />
          )}
        </>
      );
    }

    function CreateModal({ onClose, onSubmit, user }) {
      const [category, setCategory] = useState('Price');
      const [title, setTitle] = useState('');
      const [ticker, setTicker] = useState('');
      const [company, setCompany] = useState('');
      const [endsAt, setEndsAt] = useState('');
      const [showConfirm, setShowConfirm] = useState(false);
      const [loading, setLoading] = useState(false);

      const isPriceCategory = category === 'Price';
      const minDate = getTodayDate();

      const handleSubmit = (e) => {
        e.preventDefault();
        setShowConfirm(true);
      };

      const handleConfirmSubmit = async () => {
        setLoading(true);
        const data = {
          title,
          category,
          ticker: ticker.toUpperCase() || null,
          company: company || null,
          ends_at: endsAt,
          created_by: user.id
        };
        await onSubmit(data);
        setShowConfirm(false);
        setLoading(false);
        onClose();
      };

      const formattedDate = endsAt ? new Date(endsAt).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : '';

      return (
        <>
          <div className="modal-overlay" onClick={onClose}>
            <div className="create-modal" onClick={e => e.stopPropagation()}>
              <div className="create-modal-header">
                <h2 className="create-modal-title">Suggest a Prediction</h2>
                <button className="close-btn" onClick={onClose}>√ó</button>
              </div>
              <form onSubmit={handleSubmit}>
                <div className="create-modal-body">
                  <div className="form-group">
                    <label className="form-label">Category</label>
                    <div className="category-select-group">
                      {['Price', 'Events', 'Other'].map(cat => (
                        <button key={cat} type="button" className={`category-select-btn ${category === cat ? 'active' : ''}`} onClick={() => setCategory(cat)}>{cat}</button>
                      ))}
                    </div>
                  </div>
                  <div className="form-group">
                    <label className="form-label">Ticker Symbol</label>
                    <input type="text" className="form-input" placeholder="e.g., MVCO" value={ticker} onChange={(e) => setTicker(e.target.value)} maxLength={5} required />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Company Name</label>
                    <input type="text" className="form-input" placeholder="e.g., Metavesco Inc" value={company} onChange={(e) => setCompany(e.target.value)} required />
                  </div>
                  <div className="form-group">
                    <label className="form-label">{isPriceCategory ? 'Prediction Question' : 'Prediction Title'}</label>
                    <textarea className="form-textarea" placeholder={isPriceCategory ? "e.g., Will MVCO close above $0.01 this week?" : "e.g., New partnership announced this month"} value={title} onChange={(e) => setTitle(e.target.value)} required />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Resolution Date</label>
                    <input type="date" className="form-input" value={endsAt} onChange={(e) => setEndsAt(e.target.value)} min={minDate} required />
                  </div>
                </div>
                <div className="create-modal-footer">
                  <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                  <button type="submit" className="btn btn-primary" style={{width:'auto'}}>Submit for Review</button>
                </div>
              </form>
            </div>
          </div>

          {showConfirm && (
            <ConfirmModal
              icon="üìù"
              title="Submit Prediction?"
              message="Your prediction will be sent to admins for review before going live."
              details={[
                { label: "Category", value: category },
                { label: "Ticker", value: ticker.toUpperCase() },
                { label: "Company", value: company },
                { label: "Prediction", value: title.length > 50 ? title.substring(0, 50) + '...' : title },
                { label: "Resolution Date", value: formattedDate }
              ]}
              confirmText={loading ? "Submitting..." : "Submit Prediction"}
              onConfirm={handleConfirmSubmit}
              onCancel={() => setShowConfirm(false)}
            />
          )}
        </>
      );
    }

    function MarketsPage({ markets, onMarketClick, onCreateClick, weeklyBetUsed, loading }) {
      const [activeCategory, setActiveCategory] = useState('All');
      const activeMarkets = markets.filter(m => m.status === 'active');
      const filtered = activeMarkets.filter(m => activeCategory === 'All' || m.category === activeCategory);
      
      if (loading) {
        return <main className="main"><div className="loading"><div className="loading-spinner">‚ü≥</div><p>Loading markets...</p></div></main>;
      }

      return (
        <main className="main">
          <h1 className="page-title">Trade OTC Stock Outcomes</h1>
          <p className="page-subtitle">Predict price movements, events, and more. Win 1,000 OTCfi for each correct prediction!</p>
          <div className="stats-row">
            <div style={{ display: 'flex', gap: '3rem' }}>
              <div className="stat-group"><span className="stat-label">Available Balance</span><span className="stat-value">10,000 credits</span></div>
              <div className="stat-group"><span className="stat-label">Weekly Bet</span><span className={`bet-status-badge ${weeklyBetUsed ? 'bet-used' : 'bet-available'}`}>{weeklyBetUsed ? '‚úó Used' : '‚úì Available'}</span></div>
            </div>
            <div><button className="suggest-btn" onClick={onCreateClick}>+ Suggest Prediction</button></div>
          </div>
          <div className="category-filters">{categories.map(cat => <button key={cat} className={`category-pill ${activeCategory === cat ? 'active' : ''}`} onClick={() => setActiveCategory(cat)}>{cat}</button>)}</div>
          <div className="market-grid">{filtered.map(market => <MarketCard key={market.id} market={market} onClick={onMarketClick} />)}</div>
          {filtered.length === 0 && <div className="empty-state"><div className="empty-state-icon">üìä</div><div className="empty-state-title">No markets found</div><p>Try selecting a different category.</p></div>}
        </main>
      );
    }

    function PortfolioPage({ userBets, markets }) {
      const userMarkets = markets.filter(m => userBets.find(b => b.market_id === m.id));
      return (
        <main className="main">
          <h1 className="page-title">Portfolio</h1>
          <p className="page-subtitle">Track your active predictions and past performance.</p>
          {userMarkets.length === 0 ? (
            <div className="empty-state"><div className="empty-state-icon">üìà</div><div className="empty-state-title">No positions yet</div><p>Click a market to place your first trade.</p></div>
          ) : (
            <><h2 style={{ marginBottom: '1rem', fontSize: '1.1rem' }}>Open Positions</h2>
            <div className="market-grid">{userMarkets.map(market => {
              const bet = userBets.find(b => b.market_id === market.id);
              return (
                <div key={market.id} className="market-card">
                  <div className="market-header">
                    <div className="market-ticker-row">
                      {market.ticker && <span className="ticker-badge">{market.ticker}</span>}
                      {market.company && <span className="market-company">{market.company}</span>}
                      <span className="category-badge">{market.category}</span>
                    </div>
                    <span className={`bet-status-badge ${bet?.side === 'yes' ? 'bet-available' : 'bet-used'}`}>{bet?.side?.toUpperCase()}</span>
                  </div>
                  <h3 className="market-title">{market.title}</h3>
                  <div className="market-footer"><div className="market-meta"><span>Ends {formatDate(market.ends_at)}</span></div><div className="market-meta"><span>Reward: 1,000 OTCfi</span></div></div>
                </div>
              );
            })}</div></>
          )}
        </main>
      );
    }

    function LeaderboardPage({ leaderboard, onViewProfile, loading }) {
      if (loading) {
        return <main className="main"><div className="loading"><div className="loading-spinner">‚ü≥</div><p>Loading leaderboard...</p></div></main>;
      }

      return (
        <main className="main">
          <h1 className="page-title">Leaderboard</h1>
          <p className="page-subtitle">Top predictors ranked by wins and earnings.</p>
          <div className="leaderboard">
            <div className="leaderboard-header">üèÜ Top Predictors</div>
            {leaderboard.length === 0 ? (
              <div className="leaderboard-row"><span style={{ color: 'var(--text-muted)' }}>No users yet. Be the first!</span></div>
            ) : (
              leaderboard.map((user, i) => (
                <div key={user.id} className="leaderboard-row" onClick={() => onViewProfile(user.id)} style={{ cursor: 'pointer' }}>
                  <span className={`leaderboard-rank ${i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : ''}`}>#{i + 1}</span>
                  <div className="leaderboard-user">
                    <div className="leaderboard-avatar">
                      {user.avatar_url ? <img src={user.avatar_url} alt="" /> : user.username?.substring(0, 2).toUpperCase()}
                    </div>
                    <span className="leaderboard-name">{user.username}</span>
                  </div>
                  <div className="leaderboard-stats">
                    <span className="leaderboard-wins">{user.total_wins || 0} wins</span>
                    <span className="leaderboard-earnings">{(user.total_earnings || 0).toLocaleString()} OTCfi</span>
                  </div>
                </div>
              ))
            )}
          </div>
        </main>
      );
    }

    function ProfilePage({ profileUser, currentUser, userBets, markets, onUpdateProfile, onViewProfile, loading }) {
      const [walletAddress, setWalletAddress] = useState(profileUser?.wallet_address || '');
      const [profilePrivate, setProfilePrivate] = useState(profileUser?.profile_private || false);
      const [historyPrivate, setHistoryPrivate] = useState(profileUser?.betting_history_private || false);
      const [historyFilter, setHistoryFilter] = useState('all');
      const [saving, setSaving] = useState(false);
      const [saved, setSaved] = useState(false);

      const isOwnProfile = currentUser.id === profileUser?.id;
      const isAdmin = currentUser.is_admin;
      const canSeePrivate = isOwnProfile || isAdmin;

      // Calculate stats
      const totalBets = profileUser?.total_bets || 0;
      const totalWins = profileUser?.total_wins || 0;
      const winRate = totalBets > 0 ? Math.round((totalWins / totalBets) * 100) : 0;

      // Get user's betting history
      const userMarketBets = userBets
        .filter(b => isOwnProfile ? true : b.user_id === profileUser?.id)
        .map(bet => {
          const market = markets.find(m => m.id === bet.market_id);
          return { ...bet, market };
        })
        .filter(b => b.market);

      const filteredHistory = userMarketBets.filter(bet => {
        if (historyFilter === 'all') return true;
        if (historyFilter === 'wins') return bet.result === 'won';
        if (historyFilter === 'losses') return bet.result === 'lost';
        if (historyFilter === 'pending') return !bet.result;
        return true;
      });

      const handleSave = async () => {
        setSaving(true);
        await onUpdateProfile({
          wallet_address: walletAddress,
          profile_private: profilePrivate,
          betting_history_private: historyPrivate
        });
        setSaving(false);
        setSaved(true);
        setTimeout(() => setSaved(false), 2000);
      };

      const formatJoinDate = (date) => {
        if (!date) return 'Unknown';
        return new Date(date).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      };

      if (loading || !profileUser) {
        return <main className="main"><div className="loading"><div className="loading-spinner">‚ü≥</div><p>Loading profile...</p></div></main>;
      }

      // Check if profile is private
      if (profileUser.profile_private && !canSeePrivate) {
        return (
          <main className="main">
            <div className="profile-header">
              <div className="profile-avatar-large">
                {profileUser.avatar_url ? <img src={profileUser.avatar_url} alt="" /> : profileUser.username?.substring(0, 2).toUpperCase()}
              </div>
              <div className="profile-info">
                <h1 className="profile-username">{profileUser.username}</h1>
                <p className="profile-private-notice">üîí This profile is private</p>
              </div>
            </div>
            <div className="profile-section">
              <h3 className="profile-section-title">üìä Public Stats</h3>
              <div className="stats-grid">
                <div className="stat-card"><div className="stat-card-value">{profileUser.total_wins || 0}</div><div className="stat-card-label">Total Wins</div></div>
                <div className="stat-card"><div className="stat-card-value">{(profileUser.total_earnings || 0).toLocaleString()}</div><div className="stat-card-label">OTCfi Earned</div></div>
              </div>
            </div>
          </main>
        );
      }

      return (
        <main className="main">
          <div className="profile-header">
            <div className="profile-avatar-large">
              {profileUser.avatar_url ? <img src={profileUser.avatar_url} alt="" /> : profileUser.username?.substring(0, 2).toUpperCase()}
            </div>
            <div className="profile-info">
              <h1 className="profile-username">
                {profileUser.username}
                {profileUser.is_admin && <span className="admin-badge">ADMIN</span>}
              </h1>
              <p className="profile-joined">Member since {formatJoinDate(profileUser.created_at)}</p>
            </div>
          </div>

          <div className="profile-section">
            <h3 className="profile-section-title">üìä Stats</h3>
            <div className="stats-grid">
              <div className="stat-card"><div className="stat-card-value">{totalWins}</div><div className="stat-card-label">Total Wins</div></div>
              <div className="stat-card"><div className="stat-card-value">{(profileUser.total_earnings || 0).toLocaleString()}</div><div className="stat-card-label">OTCfi Earned</div></div>
              <div className="stat-card"><div className="stat-card-value">{winRate}%</div><div className="stat-card-label">Win Rate</div></div>
              <div className="stat-card"><div className="stat-card-value">{totalBets}</div><div className="stat-card-label">Total Bets</div></div>
              <div className="stat-card"><div className="stat-card-value">{profileUser.current_streak || 0}</div><div className="stat-card-label">Current Streak</div></div>
              <div className="stat-card"><div className="stat-card-value">{profileUser.best_streak || 0}</div><div className="stat-card-label">Best Streak</div></div>
            </div>
          </div>

          {isOwnProfile && (
            <div className="profile-section">
              <h3 className="profile-section-title">üí∞ Wallet Address</h3>
              <p style={{ color: 'var(--text-muted)', fontSize: '0.85rem', marginBottom: '0.75rem' }}>Used for receiving OTCfi payouts. Only visible to you and admins.</p>
              <input 
                type="text" 
                className="form-input" 
                placeholder="Enter your wallet address..." 
                value={walletAddress} 
                onChange={(e) => setWalletAddress(e.target.value)}
                style={{ marginBottom: '1rem' }}
              />
            </div>
          )}

          {canSeePrivate && profileUser.wallet_address && !isOwnProfile && (
            <div className="profile-section">
              <h3 className="profile-section-title">üí∞ Wallet Address (Admin View)</h3>
              <p style={{ color: 'var(--text-secondary)', fontFamily: 'monospace', background: 'var(--bg-input)', padding: '0.75rem', borderRadius: '8px' }}>{profileUser.wallet_address}</p>
            </div>
          )}

          {isOwnProfile && (
            <div className="profile-section">
              <h3 className="profile-section-title">üîí Privacy Settings</h3>
              <div className="privacy-toggle">
                <label className="toggle-label">
                  <input type="checkbox" checked={profilePrivate} onChange={(e) => setProfilePrivate(e.target.checked)} />
                  <span className="toggle-text">Make profile private</span>
                </label>
                <p className="toggle-description">Only your username and leaderboard stats will be visible to others</p>
              </div>
              <div className="privacy-toggle">
                <label className="toggle-label">
                  <input type="checkbox" checked={historyPrivate} onChange={(e) => setHistoryPrivate(e.target.checked)} />
                  <span className="toggle-text">Hide betting history</span>
                </label>
                <p className="toggle-description">Others won't see your betting history (admins can still see)</p>
              </div>
              <button className="btn btn-primary" onClick={handleSave} disabled={saving} style={{ marginTop: '1rem' }}>
                {saving ? 'Saving...' : saved ? '‚úì Saved!' : 'Save Changes'}
              </button>
            </div>
          )}

          {(canSeePrivate || !profileUser.betting_history_private) && (
            <div className="profile-section">
              <h3 className="profile-section-title">üìú Betting History</h3>
              <div className="history-filters">
                {['all', 'wins', 'losses', 'pending'].map(f => (
                  <button 
                    key={f} 
                    className={`category-pill ${historyFilter === f ? 'active' : ''}`}
                    onClick={() => setHistoryFilter(f)}
                  >
                    {f.charAt(0).toUpperCase() + f.slice(1)}
                  </button>
                ))}
              </div>
              {filteredHistory.length === 0 ? (
                <p style={{ color: 'var(--text-muted)', padding: '1rem 0' }}>No bets found</p>
              ) : (
                <div className="history-list">
                  {filteredHistory.map(bet => (
                    <div key={bet.id} className="history-item">
                      <div className="history-info">
                        <div className="history-market">{bet.market?.ticker && <span className="ticker-badge" style={{ marginRight: '0.5rem' }}>{bet.market.ticker}</span>}{bet.market?.title}</div>
                        <div className="history-meta">Picked: <span className={bet.side === 'yes' ? 'text-green' : 'text-red'}>{bet.side?.toUpperCase()}</span></div>
                      </div>
                      <div className={`history-result ${bet.result || 'pending'}`}>
                        {bet.result === 'won' ? '‚úì Won' : bet.result === 'lost' ? '‚úó Lost' : '‚è≥ Pending'}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </main>
      );
    }

    function AdminPage({ pendingPredictions, onApprove, onReject, markets, onResolve, allUsers, onToggleAdmin, onDeleteUser, loading }) {
      const [userSearch, setUserSearch] = useState('');
      const [deleteConfirm, setDeleteConfirm] = useState(null);
      
      const activeMarkets = markets.filter(m => m.status === 'active');
      const filteredUsers = allUsers.filter(u => 
        u.username?.toLowerCase().includes(userSearch.toLowerCase()) ||
        u.discord_id?.includes(userSearch)
      );

      if (loading) {
        return <main className="main"><div className="loading"><div className="loading-spinner">‚ü≥</div><p>Loading admin panel...</p></div></main>;
      }

      return (
        <main className="main">
          <h1 className="page-title">Admin Panel</h1>
          <p className="page-subtitle">Manage predictions, resolve markets, and control user access.</p>
          <div className="admin-section">
            <h3 className="admin-section-title">üìã Pending Predictions ({pendingPredictions.length})</h3>
            {pendingPredictions.length === 0 ? <p style={{ color: 'var(--text-muted)' }}>No pending predictions</p> : pendingPredictions.map(pred => (
              <div key={pred.id} className="pending-item">
                <div className="pending-info">
                  <div className="pending-title">{pred.ticker ? `${pred.ticker} - ` : ''}{pred.title}</div>
                  <div className="pending-meta">{pred.category} ‚Ä¢ Ends {formatDate(pred.ends_at)}</div>
                </div>
                <div className="pending-actions">
                  <button className="btn-sm btn-approve" onClick={() => onApprove(pred)}>Approve</button>
                  <button className="btn-sm btn-reject" onClick={() => onReject(pred.id)}>Reject</button>
                </div>
              </div>
            ))}
          </div>
          <div className="admin-section">
            <h3 className="admin-section-title">‚úÖ Resolve Active Markets</h3>
            {activeMarkets.length === 0 ? <p style={{ color: 'var(--text-muted)' }}>No active markets</p> : activeMarkets.map(market => (
              <div key={market.id} className="pending-item">
                <div className="pending-info">
                  <div className="pending-title">{market.ticker ? `${market.ticker} - ` : ''}{market.title}</div>
                  <div className="pending-meta">{market.category} ‚Ä¢ Ends {formatDate(market.ends_at)} ‚Ä¢ Vol: {market.volume?.toLocaleString() || 0}</div>
                </div>
                <div className="pending-actions">
                  <button className="btn-sm btn-approve" onClick={() => onResolve(market.id, 'yes')}>YES Won</button>
                  <button className="btn-sm btn-reject" onClick={() => onResolve(market.id, 'no')}>NO Won</button>
                </div>
              </div>
            ))}
          </div>
          <div className="admin-section">
            <h3 className="admin-section-title">üë• Manage Users ({allUsers.length})</h3>
            <input 
              type="text" 
              className="form-input" 
              placeholder="Search users..." 
              value={userSearch} 
              onChange={(e) => setUserSearch(e.target.value)}
              style={{ marginBottom: '1rem' }}
            />
            {filteredUsers.length === 0 ? <p style={{ color: 'var(--text-muted)' }}>No users found</p> : filteredUsers.map(u => (
              <div key={u.id} className="pending-item">
                <div className="pending-info" style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                  <div className="leaderboard-avatar" style={{ width: '32px', height: '32px', borderRadius: '6px', flexShrink: 0 }}>
                    {u.avatar_url ? <img src={u.avatar_url} alt="" style={{ width: '100%', height: '100%', objectFit: 'cover', borderRadius: '6px' }} /> : u.username?.substring(0, 2).toUpperCase()}
                  </div>
                  <div>
                    <div className="pending-title">{u.username} {u.is_admin && <span style={{ color: 'var(--accent-purple)', fontSize: '0.75rem' }}>‚Ä¢ ADMIN</span>}</div>
                    <div className="pending-meta">@{u.username} ‚Ä¢ {u.total_wins || 0} wins ‚Ä¢ {(u.total_earnings || 0).toLocaleString()} OTCfi</div>
                  </div>
                </div>
                <div className="pending-actions">
                  {u.is_admin ? (
                    <button className="btn-sm btn-reject" onClick={() => onToggleAdmin(u.id, false)}>Remove Admin</button>
                  ) : (
                    <button className="btn-sm btn-approve" onClick={() => onToggleAdmin(u.id, true)}>Make Admin</button>
                  )}
                  <button className="btn-sm btn-reject" onClick={() => setDeleteConfirm(u)} style={{ marginLeft: '0.5rem' }}>üóëÔ∏è</button>
                </div>
              </div>
            ))}
          </div>
          
          {deleteConfirm && (
            <ConfirmModal
              icon="‚ö†Ô∏è"
              title="Delete User?"
              message={`Are you sure you want to delete ${deleteConfirm.username}? This cannot be undone.`}
              details={[
                { label: "Username", value: deleteConfirm.username },
                { label: "Wins", value: deleteConfirm.total_wins || 0 },
                { label: "Earnings", value: `${(deleteConfirm.total_earnings || 0).toLocaleString()} OTCfi` }
              ]}
              warning="This will permanently delete the user and all their bets."
              confirmText="Delete User"
              onConfirm={() => { onDeleteUser(deleteConfirm.id); setDeleteConfirm(null); }}
              onCancel={() => setDeleteConfirm(null)}
            />
          )}
        </main>
      );
    }

    function App() {
      const [session, setSession] = useState(null);
      const [user, setUser] = useState(null);
      const [activePage, setActivePage] = useState('markets');
      const [markets, setMarkets] = useState([]);
      const [leaderboard, setLeaderboard] = useState([]);
      const [pendingPredictions, setPendingPredictions] = useState([]);
      const [allUsers, setAllUsers] = useState([]);
      const [userBets, setUserBets] = useState([]);
      const [allBets, setAllBets] = useState([]);
      const [profileUser, setProfileUser] = useState(null);
      const [selectedMarket, setSelectedMarket] = useState(null);
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [toasts, setToasts] = useState([]);
      const [loading, setLoading] = useState(true);
      const [initializing, setInitializing] = useState(true);
      const [dataLoaded, setDataLoaded] = useState(false);

      const addToast = (msg, type = 'success') => setToasts(prev => [...prev, { id: Date.now(), message: msg, type }]);
      const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));

      const weeklyBetUsed = user?.weekly_bet_used || false;

      // Check for existing session on mount
      useEffect(() => {
        let mounted = true;

        supabase.auth.getSession().then(({ data: { session } }) => {
          if (!mounted) return;
          setSession(session);
          if (session) {
            handleAuthUser(session.user);
          } else {
            setInitializing(false);
          }
        });

        const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
          if (!mounted) return;
          // Only handle specific events, ignore token refresh and other background events
          if (event === 'SIGNED_IN') {
            setSession(session);
            if (session) handleAuthUser(session.user);
          } else if (event === 'SIGNED_OUT') {
            setSession(null);
            setUser(null);
            setInitializing(false);
          }
        });

        return () => {
          mounted = false;
          subscription.unsubscribe();
        };
      }, []);

      const handleAuthUser = async (authUser) => {
        try {
          // Get Discord metadata
          const discordUsername = authUser.user_metadata?.full_name || authUser.user_metadata?.name || authUser.email?.split('@')[0];
          const discordAvatar = authUser.user_metadata?.avatar_url;
          const discordId = authUser.user_metadata?.provider_id;

          // Check if user exists in our users table
          let { data: existingUser, error: fetchError } = await supabase
            .from('users')
            .select('*')
            .eq('discord_id', discordId)
            .single();

          if (fetchError && fetchError.code !== 'PGRST116') {
            // Try by username
            const { data: userByName } = await supabase
              .from('users')
              .select('*')
              .eq('username', discordUsername.toLowerCase())
              .single();
            existingUser = userByName;
          }

          if (existingUser) {
            // Update avatar if changed
            if (existingUser.avatar_url !== discordAvatar) {
              await supabase
                .from('users')
                .update({ avatar_url: discordAvatar })
                .eq('id', existingUser.id);
            }
            setUser({ ...existingUser, avatar_url: discordAvatar, user_metadata: authUser.user_metadata });
          } else {
            // Create new user
            const { data: newUser, error: insertError } = await supabase
              .from('users')
              .insert([{ 
                username: discordUsername.toLowerCase(),
                discord_id: discordId,
                avatar_url: discordAvatar
              }])
              .select()
              .single();

            if (insertError) throw insertError;
            setUser({ ...newUser, user_metadata: authUser.user_metadata });
          }
        } catch (err) {
          console.error('Error handling auth user:', err);
          addToast('Error setting up profile', 'error');
        } finally {
          setInitializing(false);
        }
      };

      // Load data when user is set - only once
      useEffect(() => {
        if (user && !dataLoaded) {
          loadData();
        }
      }, [user, dataLoaded]);

      const loadData = async () => {
        if (dataLoaded) return;
        setLoading(true);
        try {
          // Fetch all markets (active and resolved) for profile history
          const { data: marketsData } = await supabase
            .from('markets')
            .select('*')
            .order('created_at', { ascending: false });
          setMarkets(marketsData || []);

          const { data: leaderboardData } = await supabase
            .from('users')
            .select('*')
            .order('total_wins', { ascending: false })
            .limit(10);
          setLeaderboard(leaderboardData || []);

          const { data: betsData } = await supabase
            .from('bets')
            .select('*')
            .eq('user_id', user.id);
          setUserBets(betsData || []);

          if (user.is_admin) {
            const { data: pendingData } = await supabase
              .from('pending_predictions')
              .select('*')
              .order('created_at', { ascending: false });
            setPendingPredictions(pendingData || []);

            const { data: usersData } = await supabase
              .from('users')
              .select('*')
              .order('username', { ascending: true });
            setAllUsers(usersData || []);
          }
          setDataLoaded(true);
        } catch (err) {
          console.error('Error loading data:', err);
          addToast('Failed to load data', 'error');
        } finally {
          setLoading(false);
        }
      };

      const refreshData = async () => {
        setLoading(true);
        try {
          const { data: marketsData } = await supabase
            .from('markets')
            .select('*')
            .order('created_at', { ascending: false });
          setMarkets(marketsData || []);

          const { data: leaderboardData } = await supabase
            .from('users')
            .select('*')
            .order('total_wins', { ascending: false })
            .limit(10);
          setLeaderboard(leaderboardData || []);

          const { data: betsData } = await supabase
            .from('bets')
            .select('*')
            .eq('user_id', user.id);
          setUserBets(betsData || []);

          if (user.is_admin) {
            const { data: pendingData } = await supabase
              .from('pending_predictions')
              .select('*')
              .order('created_at', { ascending: false });
            setPendingPredictions(pendingData || []);

            const { data: usersData } = await supabase
              .from('users')
              .select('*')
              .order('username', { ascending: true });
            setAllUsers(usersData || []);
          }
        } catch (err) {
          console.error('Error loading data:', err);
          addToast('Failed to load data', 'error');
        } finally {
          setLoading(false);
        }
      };

      const handleLogout = async () => {
        await supabase.auth.signOut();
        setUser(null);
        setSession(null);
        setMarkets([]);
        setUserBets([]);
        setAllUsers([]);
        setDataLoaded(false);
        setActivePage('markets');
      };

      const handleBet = async (marketId, side) => {
        if (weeklyBetUsed) {
          addToast('You already used your weekly bet!', 'error');
          return;
        }

        try {
          const { error: betError } = await supabase
            .from('bets')
            .insert([{ user_id: user.id, market_id: marketId, side }]);

          if (betError) throw betError;

          const { error: userError } = await supabase
            .from('users')
            .update({ weekly_bet_used: true })
            .eq('id', user.id);

          if (userError) throw userError;

          const market = markets.find(m => m.id === marketId);
          const newYes = side === 'yes' ? Math.min(99, market.yes_percent + 1) : Math.max(1, market.yes_percent - 1);
          const newNo = 100 - newYes;

          await supabase
            .from('markets')
            .update({ 
              volume: (market.volume || 0) + 1000,
              yes_percent: newYes,
              no_percent: newNo
            })
            .eq('id', marketId);

          setUser({ ...user, weekly_bet_used: true });
          setUserBets([...userBets, { user_id: user.id, market_id: marketId, side }]);
          setMarkets(markets.map(m => m.id === marketId ? { ...m, volume: (m.volume || 0) + 1000, yes_percent: newYes, no_percent: newNo } : m));
          setSelectedMarket(null);
          addToast(`Bet placed on ${side.toUpperCase()}! Win 1,000 OTCfi if correct üéØ`);
        } catch (err) {
          console.error('Error placing bet:', err);
          addToast('Failed to place bet. Please try again.', 'error');
        }
      };

      const handleCreatePrediction = async (data) => {
        try {
          const { error } = await supabase
            .from('pending_predictions')
            .insert([data]);

          if (error) throw error;
          addToast('Prediction submitted for review!');
        } catch (err) {
          console.error('Error submitting prediction:', err);
          addToast('Failed to submit prediction.', 'error');
        }
      };

      const handleApprovePrediction = async (pred) => {
        try {
          const { error: insertError } = await supabase
            .from('markets')
            .insert([{
              title: pred.title,
              category: pred.category,
              ticker: pred.ticker,
              company: pred.company,
              ends_at: pred.ends_at,
              resolution: `This market resolves based on: ${pred.title}`,
              created_by: pred.created_by
            }]);

          if (insertError) throw insertError;

          const { error: deleteError } = await supabase
            .from('pending_predictions')
            .delete()
            .eq('id', pred.id);

          if (deleteError) throw deleteError;

          await refreshData();
          addToast('Prediction approved!');
        } catch (err) {
          console.error('Error approving prediction:', err);
          addToast('Failed to approve prediction.', 'error');
        }
      };

      const handleRejectPrediction = async (id) => {
        try {
          const { error } = await supabase
            .from('pending_predictions')
            .delete()
            .eq('id', id);

          if (error) throw error;
          setPendingPredictions(pendingPredictions.filter(p => p.id !== id));
          addToast('Prediction rejected', 'error');
        } catch (err) {
          console.error('Error rejecting prediction:', err);
          addToast('Failed to reject prediction.', 'error');
        }
      };

      const handleResolveMarket = async (id, winner) => {
        try {
          const { error } = await supabase
            .from('markets')
            .update({ status: 'resolved', winner, resolved_at: new Date().toISOString() })
            .eq('id', id);

          if (error) throw error;

          setMarkets(markets.filter(m => m.id !== id));
          addToast(`Market resolved! ${winner.toUpperCase()} wins!`);
        } catch (err) {
          console.error('Error resolving market:', err);
          addToast('Failed to resolve market.', 'error');
        }
      };

      const handleToggleAdmin = async (userId, makeAdmin) => {
        try {
          const { error } = await supabase
            .from('users')
            .update({ is_admin: makeAdmin })
            .eq('id', userId);

          if (error) throw error;

          setAllUsers(allUsers.map(u => u.id === userId ? { ...u, is_admin: makeAdmin } : u));
          addToast(makeAdmin ? 'User is now an admin!' : 'Admin access removed');
        } catch (err) {
          console.error('Error updating admin status:', err);
          addToast('Failed to update admin status.', 'error');
        }
      };

      const handleDeleteUser = async (userId) => {
        try {
          // Delete user's bets first
          await supabase
            .from('bets')
            .delete()
            .eq('user_id', userId);

          // Delete user
          const { error } = await supabase
            .from('users')
            .delete()
            .eq('id', userId);

          if (error) throw error;

          setAllUsers(allUsers.filter(u => u.id !== userId));
          addToast('User deleted successfully');
        } catch (err) {
          console.error('Error deleting user:', err);
          addToast('Failed to delete user.', 'error');
        }
      };

      const handleViewProfile = async (userId) => {
        try {
          setLoading(true);
          
          // If viewing own profile, use current user data
          if (userId === user.id) {
            setProfileUser(user);
          } else {
            // Fetch the user's profile
            const { data: profileData, error } = await supabase
              .from('users')
              .select('*')
              .eq('id', userId)
              .single();
            
            if (error) throw error;
            setProfileUser(profileData);
          }
          
          // Fetch user's bets for history
          const { data: betsData } = await supabase
            .from('bets')
            .select('*')
            .eq('user_id', userId);
          setAllBets(betsData || []);
          
          setActivePage('profile');
        } catch (err) {
          console.error('Error loading profile:', err);
          addToast('Failed to load profile', 'error');
        } finally {
          setLoading(false);
        }
      };

      const handleUpdateProfile = async (updates) => {
        try {
          const { error } = await supabase
            .from('users')
            .update(updates)
            .eq('id', user.id);

          if (error) throw error;

          // Update local user state
          setUser({ ...user, ...updates });
          setProfileUser({ ...profileUser, ...updates });
          addToast('Profile updated!');
        } catch (err) {
          console.error('Error updating profile:', err);
          addToast('Failed to update profile', 'error');
        }
      };

      // Show loading while checking auth
      if (initializing) {
        return (
          <div className="login-container">
            <div className="loading">
              <div className="loading-spinner">‚ü≥</div>
              <p>Loading...</p>
            </div>
          </div>
        );
      }

      // Show login if no user
      if (!user) {
        return (
          <>
            <Login />
            <div className="toast-container">{toasts.map(toast => <Toast key={toast.id} message={toast.message} type={toast.type} onClose={() => removeToast(toast.id)} />)}</div>
          </>
        );
      }

      const currentUserBet = selectedMarket ? userBets.find(b => b.market_id === selectedMarket.id) : null;

      return (
        <AppContext.Provider value={{ weeklyBetUsed, userBets }}>
          <Header user={user} activePage={activePage} setActivePage={setActivePage} onLogout={handleLogout} onViewProfile={handleViewProfile} />
          {activePage === 'markets' && <MarketsPage markets={markets} onMarketClick={setSelectedMarket} onCreateClick={() => setShowCreateModal(true)} weeklyBetUsed={weeklyBetUsed} loading={loading} />}
          {activePage === 'portfolio' && <PortfolioPage userBets={userBets} markets={markets} />}
          {activePage === 'leaderboard' && <LeaderboardPage leaderboard={leaderboard} onViewProfile={handleViewProfile} loading={loading} />}
          {activePage === 'profile' && <ProfilePage profileUser={profileUser} currentUser={user} userBets={allBets} markets={markets} onUpdateProfile={handleUpdateProfile} onViewProfile={handleViewProfile} loading={loading} />}
          {activePage === 'admin' && user.is_admin && <AdminPage pendingPredictions={pendingPredictions} onApprove={handleApprovePrediction} onReject={handleRejectPrediction} markets={markets} onResolve={handleResolveMarket} allUsers={allUsers} onToggleAdmin={handleToggleAdmin} onDeleteUser={handleDeleteUser} loading={loading} />}
          {selectedMarket && <MarketDetail market={selectedMarket} onClose={() => setSelectedMarket(null)} onBet={handleBet} weeklyBetUsed={weeklyBetUsed} userBet={currentUserBet} />}
          {showCreateModal && <CreateModal onClose={() => setShowCreateModal(false)} onSubmit={handleCreatePrediction} user={user} />}
          <div className="toast-container">{toasts.map(toast => <Toast key={toast.id} message={toast.message} type={toast.type} onClose={() => removeToast(toast.id)} />)}</div>
        </AppContext.Provider>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
